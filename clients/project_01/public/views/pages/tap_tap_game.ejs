<%- include('../partials/header') %>

    <section class="max-w-4xl mx-auto px-4 py-8">
        <div class="max-w-lg mx-auto">

            <!-- Header -->
            <div class="bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 rounded-lg p-4 shadow-xl">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">

                    <!-- Left Section -->
                    <div class="min-w-0">
                        <h1 class="text-2xl font-semibold leading-tight truncate">
                            Daily Bonus
                        </h1>

                        <p class="text-slate-300 text-sm mt-1 truncate">
                            @<%= (user && user.username) ? user.username : '—' %>
                        </p>
                    </div>

                    <!-- Right Button -->
                    <div class="w-full sm:w-auto sm:flex-none">
                        <a href="https://t.me/<%= support_telegram_username %>" target="_blank" class="w-full inline-flex items-center justify-center px-4 py-2 rounded-lg
              bg-slate-700/70 hover:bg-slate-700
              border border-slate-600 text-sm text-sky-300 transition">
                            Help Support
                        </a>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <% if (typeof error !=='undefined' && error) { %>
                    <div class="p-3 rounded-md bg-red-900/40 text-red-200 mb-4">
                        <%= error %>
                    </div>
                    <% } %>

                        <p class="text-sm text-slate-400 mb-3">
                            Tap to earn. You can play only for
                            <strong>
                                <%= typeof play_window_days !=='undefined' ? play_window_days : 5 %>
                            </strong>
                            days after activation.
                            Daily limit is
                            <strong>₹<%= typeof daily_cap !=='undefined' ? Number(daily_cap).toFixed(0) : 300 %>
                            </strong>
                            and you get
                            <strong>₹<%= typeof per_tap_amount !=='undefined' ? Number(per_tap_amount).toFixed(2)
                                    : '0.50' %></strong>
                            per tap.
                            Your earning is added instantly to your wallet. Tab balance is only for tracking today’s
                            limit.
                        </p>

                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div class="p-3 bg-slate-800 rounded-lg">
                                <div class="text-xs text-slate-400">Per Tap</div>
                                <div id="perTap" class="text-xl font-bold">
                                    ₹<%= typeof per_tap_amount !=='undefined' ? Number(per_tap_amount).toFixed(2)
                                        : '0.50' %>
                                </div>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg">
                                <div class="text-xs text-slate-400">Daily Limit</div>
                                <div id="dailyCap" class="text-xl font-bold">
                                    ₹<%= typeof daily_cap !=='undefined' ? Number(daily_cap).toFixed(0) : 300 %>
                                </div>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg">
                                <div class="text-xs text-slate-400">Tab Count (today)</div>
                                <div id="tabCount" class="text-xl font-bold">
                                    <%= typeof tab_count !=='undefined' ? tab_count : 0 %>
                                </div>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg">
                                <div class="text-xs text-slate-400">Tab Balance (today)</div>
                                <div id="tabBalance" class="text-xl font-bold">
                                    ₹<%= typeof tab_balance !=='undefined' ? Number(tab_balance).toFixed(2) : '0.00' %>
                                </div>
                            </div>

                            <div class="p-3 bg-slate-800 rounded-lg col-span-2">
                                <div class="text-xs text-slate-400">Wallet (withdrawable)</div>
                                <div id="walletBalance" class="text-xl font-bold">
                                    ₹<%= typeof withdrawable_balance !=='undefined' ?
                                        Number(withdrawable_balance).toFixed(2) : '0.00' %>
                                </div>
                            </div>
                        </div>

                        <% const eligiblePlay=(typeof eligible_for_play !=='undefined' ) ? Boolean(eligible_for_play) :
                            true; const cap=(typeof daily_cap !=='undefined' ) ? Number(daily_cap) : 300; const
                            tb=(typeof tab_balance !=='undefined' ) ? Number(tab_balance) : 0; const autoFlag=( typeof
                            tab_auto_credited_flag !=='undefined' ? Boolean(tab_auto_credited_flag) : Boolean(user &&
                            user.tab_tab_game && user.tab_tab_game.auto_credited_flag) ); const reachedToday=autoFlag ||
                            (tb>= cap);
                            %>

                            <div id="eligibility"
                                class="mb-4 text-sm <%= eligiblePlay ? 'text-emerald-300' : 'text-yellow-300' %>">
                                <% if (!eligiblePlay) { %>
                                    Not eligible. Your Daily Bonus play window is expired.
                                    <% } else if (reachedToday) { %>
                                        Daily limit reached for today. Come back tomorrow.
                                        <% } else { %>
                                            You are eligible to tap today.
                                            <% } %>
                            </div>

                            <button id="tapBtn"
                                class="w-full px-4 py-3 rounded-lg bg-amber-500 text-slate-900 font-semibold shadow transform transition-transform">
                                Tap!
                            </button>

                            <div id="message" class="mt-4 text-sm text-slate-300"></div>

                            <!-- animation container (fixed on viewport) -->
                            <div id="anim" class="fixed left-0 top-0 w-full h-full pointer-events-none"></div>

                            <div class="text-center mt-6 text-xs text-slate-500">
                                Note: Daily limit resets automatically every day.
                            </div>
            </div>
        </div>
    </section>

    <script>
        (function () {
            const userDB_id = '<%= (user && user._id) ? user._id : "" %>';
            const PER_TAP = Number('<%= typeof per_tap_amount !== "undefined" ? Number(per_tap_amount).toFixed(2) : 0.5 %>');
            const DAILY_CAP = Number('<%= typeof daily_cap !== "undefined" ? Number(daily_cap).toFixed(0) : 300 %>');
            const ELIGIBLE_FOR_PLAY =
                '<%= (typeof eligible_for_play !== "undefined" && eligible_for_play) ? "true" : "false" %>' === 'true';

            const tabCountEl = document.getElementById('tabCount');
            const tabBalanceEl = document.getElementById('tabBalance');
            const walletEl = document.getElementById('walletBalance');
            const eligibilityEl = document.getElementById('eligibility');
            const tapBtn = document.getElementById('tapBtn');
            const messageEl = document.getElementById('message');
            const animRoot = document.getElementById('anim');

            let isLoading = false;

            function getCurrentTabBalance() {
                return parseFloat((tabBalanceEl.textContent || '₹0').replace(/[^\d.]/g, '')) || 0;
            }

            function showToast(txt) {
                messageEl.textContent = txt;
                setTimeout(() => { if (messageEl.textContent === txt) messageEl.textContent = ''; }, 2500);
            }

            function pulseButton() {
                if (tapBtn.disabled) return;
                tapBtn.style.transform = 'scale(0.96)';
                setTimeout(() => tapBtn.style.transform = '', 120);
            }

            function showIncrementFromButton(text) {
                try {
                    const rect = tapBtn.getBoundingClientRect();
                    const el = document.createElement('div');
                    el.className = "px-3 py-1 rounded-md bg-amber-400 text-slate-900 font-semibold shadow-lg";
                    el.style.position = 'fixed';
                    const left = rect.left + rect.width / 2;
                    el.style.left = (left - 40) + 'px';
                    const startTop = rect.top - 8;
                    el.style.top = (startTop) + 'px';
                    el.style.zIndex = 9999;
                    el.style.pointerEvents = 'none';
                    el.textContent = text;
                    animRoot.appendChild(el);

                    el.animate([
                        { transform: 'translateY(0px) scale(1)', opacity: 1 },
                        { transform: 'translateY(-80px) scale(0.95)', opacity: 0 }
                    ], { duration: 900, easing: 'cubic-bezier(.2,.9,.2,1)' });

                    setTimeout(() => el.remove(), 950);
                } catch (e) { console.error(e); }
            }

            // ---- Button State Manager ----
            // READY: enabled, normal
            // LOADING: disabled, shows "Processing..." only
            // LOCKED: disabled, shows "Tap (Disabled)" and eligibility text already explains why
            function setButtonState(state) {
                if (state === 'READY') {
                    isLoading = false;
                    tapBtn.disabled = false;
                    tapBtn.textContent = 'Tap!';
                    return;
                }

                if (state === 'LOADING') {
                    isLoading = true;
                    tapBtn.disabled = true;
                    return;
                }

                if (state === 'LOCKED') {
                    isLoading = false;
                    tapBtn.classList.add(
                        "bg-gray-300",
                        "text-gray-500",
                        "cursor-not-allowed",
                        "opacity-60"
                    );
                    tapBtn.disabled = true;
                    tapBtn.textContent = 'Tap (Disabled)';
                }
            }

            async function apiTap() {
                try {
                    const res = await axios.post('/<%= token %>/project-01/daily-bonus/tap', { userDB_id }, { timeout: 8000 });
                    return res.data || {};
                } catch (err) {
                    if (err.response) {
                        const ct = (err.response.headers['content-type'] || '').toLowerCase();
                        if (ct.includes('application/json')) return { error: err.response.data?.error || 'Tap failed — try again.' };
                        return { error: 'Tap failed — server error.' };
                    }
                    if (err.request) return { error: 'Network issue — please try again.' };
                    return { error: 'Unexpected error — try again.' };
                }
            }

            function renderEligibility(tabBal, autoFlag) {
                if (!ELIGIBLE_FOR_PLAY) {
                    eligibilityEl.classList.remove('text-emerald-300');
                    eligibilityEl.classList.add('text-yellow-300');
                    eligibilityEl.textContent = 'Not eligible. Your Daily Bonus play window is expired.';
                    setButtonState('LOCKED');
                    return;
                }

                if (tabBal >= DAILY_CAP || autoFlag) {
                    eligibilityEl.classList.remove('text-emerald-300');
                    eligibilityEl.classList.add('text-yellow-300');
                    eligibilityEl.textContent = 'Daily limit reached for today. Come back tomorrow.';
                    setButtonState('LOCKED');
                    return;
                }

                eligibilityEl.classList.remove('text-yellow-300');
                eligibilityEl.classList.add('text-emerald-300');
                eligibilityEl.textContent = 'You are eligible to tap today.';

                // IMPORTANT: if request currently running, don't flip to READY
                if (!isLoading) setButtonState('READY');
            }

            function applyData(data) {
                if (!data) return;

                if (typeof data.tab_count !== 'undefined') tabCountEl.textContent = data.tab_count;
                if (typeof data.tab_balance !== 'undefined') tabBalanceEl.textContent = `₹${Number(data.tab_balance).toFixed(2)}`;
                if (typeof data.withdrawable_balance !== 'undefined') walletEl.textContent = `₹${Number(data.withdrawable_balance).toFixed(2)}`;

                const tabBal = Number(
                    (data.tab_balance !== undefined) ? data.tab_balance : getCurrentTabBalance()
                );
                const autoFlag = Boolean(data.auto_credited_flag);

                renderEligibility(tabBal, autoFlag);
            }

            // init
            (function init() {
                if (!userDB_id) {
                    messageEl.textContent = "Missing user id. Open the game from the bot (Daily Bonus).";
                    setButtonState('LOCKED');
                    return;
                }

                // Initial render based on server-rendered numbers
                renderEligibility(getCurrentTabBalance(), false);
            })();

            tapBtn.addEventListener('click', async function () {
                if (tapBtn.disabled || isLoading) return;

                // pre-check
                if (!ELIGIBLE_FOR_PLAY) {
                    renderEligibility(getCurrentTabBalance(), false);
                    return;
                }
                if (getCurrentTabBalance() >= DAILY_CAP) {
                    renderEligibility(getCurrentTabBalance(), false);
                    return;
                }

                // loading (only "Processing..." now)
                setButtonState('LOADING');
                pulseButton();

                const prevCount = Number(tabCountEl.textContent || 0);
                const result = await apiTap();

                // end loading (but final state decided by applyData/renderEligibility)
                isLoading = false;

                if (!result || result.error) {
                    // On error: DON'T show "daily limit reached" automatically
                    showToast(result && result.error ? result.error : 'Tap failed. Try again.');
                    // restore based on current UI values
                    renderEligibility(getCurrentTabBalance(), false);
                    return;
                }

                const serverCount = Number(result.tab_count || 0);
                if (serverCount > prevCount) showIncrementFromButton(`+₹${PER_TAP.toFixed(2)}`);

                applyData(result);
            });
        })();
    </script>

    <script>
        (function () {
            const root = document.documentElement;
            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

            function numCssVar(name) {
                const v = getComputedStyle(root).getPropertyValue(name);
                const n = parseFloat(v);
                return Number.isFinite(n) ? n : 0;
            }

            function setSafeVars() {
                let top = 0;
                let bottom = 0;

                try {
                    top = tg?.safeAreaInset?.top ?? 0;
                    bottom = tg?.safeAreaInset?.bottom ?? 0;
                } catch (e) { }

                if (!top) top = numCssVar('--tg-safe-area-inset-top');
                if (!bottom) bottom = numCssVar('--tg-safe-area-inset-bottom');

                if (!top && /iPhone|iPad|iPod/i.test(navigator.userAgent)) top = 24;

                root.style.setProperty('--app-safe-top', top + 'px');
                root.style.setProperty('--app-safe-bottom', bottom + 'px');
            }

            setSafeVars();

            try { tg?.onEvent?.('safeAreaChanged', setSafeVars); } catch (e) { }
            try { tg?.onEvent?.('safe_area_changed', setSafeVars); } catch (e) { }

            try {
                if (tg?.setHeaderColor && tg?.colorScheme) {
                    tg.setHeaderColor(tg.colorScheme === 'dark' ? '#020617' : '#f8fafc');
                }
                if (tg?.setBackgroundColor && tg?.colorScheme) {
                    tg.setBackgroundColor(tg.colorScheme === 'dark' ? '#020617' : '#f8fafc');
                }
            } catch (e) { }
        })();
    </script>