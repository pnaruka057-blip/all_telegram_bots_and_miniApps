<section class="mx-auto w-full max-w-2xl px-4 py-6">
    <!-- HERO -->
    <%- include('../partials/header') %>

        <header
            class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
            <div class="flex flex-wrap items-center gap-4">
                <img class="h-16 w-16 rounded-full object-cover ring-2 ring-slate-200 shadow-sm dark:ring-slate-700"
                    src="https://res.cloudinary.com/dm8miilli/image/upload/t_fdfsd/v1767181841/Untitled_design_bildro.png"
                    alt="Group Help Advance" loading="lazy" />

                <div class="min-w-[220px] flex-1">
                    <h1 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Group Help Advance</h1>

                    <p class="mt-1 text-sm leading-6 text-slate-600 dark:text-slate-300">
                        Create Telegram-ready messages & inline button layouts quickly using built-in design tools.
                    </p>

                    <div class="mt-2 flex flex-wrap gap-x-4 gap-y-2 text-sm">
                        <a class="text-blue-600 hover:underline dark:text-blue-400"
                            href="/<%= token %>/group-help-advance/privacy-policy">
                            Privacy Policy
                        </a>
                    </div>
                </div>
            </div>

            <div class="mt-4 flex flex-col gap-2 sm:flex-row sm:flex-wrap">
                <a class="inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 active:scale-[0.99]"
                    href="/<%= token %>/group-help-advance/html_message_design">
                    Message Design (No Placeholders)
                </a>

                <a class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm hover:bg-slate-50 active:scale-[0.99]
                  dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:hover:bg-slate-900"
                    href="/<%= token %>/group-help-advance/html_message_design?placeholders=true">
                    Message Design (With Placeholders)
                </a>

                <a class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-semibold text-slate-900 shadow-sm hover:bg-slate-50 active:scale-[0.99]
                  dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:hover:bg-slate-900"
                    href="/<%= token %>/group-help-advance/buttons-design">
                    Button Design
                </a>
            </div>
        </header>

        <main class="mt-5 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <article
                class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
                <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Message Design</h2>
                <p class="mt-1 text-sm leading-6 text-slate-600 dark:text-slate-300">
                    Build Telegram HTML messages (bold, italic, links, code, etc.) and preview before using in your bot
                    settings.
                </p>
                <div class="mt-3">
                    <a class="inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700"
                        href="/<%= token %>/group-help-advance/html_message_design">
                        Open Designer
                    </a>
                </div>
            </article>

            <article
                class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
                <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Placeholders</h2>
                <p class="mt-1 text-sm leading-6 text-slate-600 dark:text-slate-300">
                    Create messages with placeholders (like user name, group title, IDs, etc.) for dynamic text in
                    welcome/rules.
                </p>
                <div class="mt-3">
                    <a class="inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700"
                        href="/<%= token %>/group-help-advance/html_message_design?placeholders=true">
                        Open With Placeholders
                    </a>
                </div>
            </article>

            <article
                class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900 sm:col-span-2">
                <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Button Design</h2>
                <p class="mt-1 text-sm leading-6 text-slate-600 dark:text-slate-300">
                    Generate inline keyboard layouts (rows/columns) and copy the final button syntax for your bot
                    configuration.
                </p>
                <div class="mt-3">
                    <a class="inline-flex items-center justify-center rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-700"
                        href="/<%= token %>/group-help-advance/buttons-design">
                        Open Button Builder
                    </a>
                </div>
            </article>
        </main>

        <%- include('../partials/footer') %>
</section>

<script>
    (function () {
        const root = document.documentElement;
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

        function numCssVar(name) {
            const v = getComputedStyle(root).getPropertyValue(name);
            const n = parseFloat(v);
            return Number.isFinite(n) ? n : 0;
        }

        function setSafeVars() {
            let top = 0;
            let bottom = 0;

            // Prefer Telegram provided insets (new clients)
            try {
                top = tg?.safeAreaInset?.top ?? 0;
                bottom = tg?.safeAreaInset?.bottom ?? 0;
            } catch (e) { }

            // Fallback to Telegram CSS vars if present
            if (!top) top = numCssVar('--tg-safe-area-inset-top');
            if (!bottom) bottom = numCssVar('--tg-safe-area-inset-bottom');

            // Last fallback for iOS-like devices if everything is 0
            if (!top && /iPhone|iPad|iPod/i.test(navigator.userAgent)) top = 24;

            root.style.setProperty('--app-safe-top', top + 'px');
            root.style.setProperty('--app-safe-bottom', bottom + 'px');
        }

        setSafeVars();

        // Keep it updated when Telegram reports changes
        try { tg?.onEvent?.('safeAreaChanged', setSafeVars); } catch (e) { }
        try { tg?.onEvent?.('safe_area_changed', setSafeVars); } catch (e) { } // some wrappers emit snake_case [web:203][web:128]

        // Optional: set header/background color so status bar icons look correct in fullscreen [page:1]
        try {
            if (tg?.setHeaderColor && tg?.colorScheme) {
                tg.setHeaderColor(tg.colorScheme === 'dark' ? '#020617' : '#f8fafc');
            }
            if (tg?.setBackgroundColor && tg?.colorScheme) {
                tg.setBackgroundColor(tg.colorScheme === 'dark' ? '#020617' : '#f8fafc');
            }
        } catch (e) { }
    })();

    try {
        const tg = window.Telegram?.WebApp;
        tg.BackButton.hide();
    } catch (e) {
        console.error("CloseButton init error:", e);
    }
</script>

<script>
  (function () {
    const SHOW_FN_NAME = 'show_10401300';
    const AD_SHOW_TIMEOUT_MS = 30000;
    const SDK_POLL_INTERVAL_MS = 500;

    // ---- Global guard: prevents multiple runs on same page ----
    const KEY = '__monetag_ads_flow_' + SHOW_FN_NAME;
    if (window[KEY]?.running || window[KEY]?.finished) return;

    window[KEY] = {
      running: true,
      finished: false,
      controller: null,
      overallTimer: null,
      pollInterval: null,
      prevHtmlOverflow: '',
      prevBodyOverflow: '',
    };

    const state = window[KEY];

    function stopper(e) {
      try {
        e.stopImmediatePropagation();
        e.preventDefault();
      } catch (_) { }
      return false;
    }

    function attachCaptureBlockers() {
      if (state.controller) return;

      // AbortController makes cleanup reliable (abort removes listeners). [web:587]
      const controller = new AbortController();
      state.controller = controller;

      const optCap = { capture: true, signal: controller.signal };
      const optWheel = { capture: true, passive: false, signal: controller.signal };

      document.addEventListener('click', stopper, optCap);
      document.addEventListener('pointerdown', stopper, optCap);
      document.addEventListener('touchstart', stopper, optCap);
      document.addEventListener('wheel', stopper, optWheel);
      document.addEventListener('keydown', stopper, optCap);
    }

    function removeCaptureBlockers() {
      try { state.controller?.abort(); } catch (_) { }
      state.controller = null;
    }

    function ensureSpinStyleOnce() {
      if (document.getElementById('adsSpinStyle')) return;
      const style = document.createElement('style');
      style.id = 'adsSpinStyle';
      style.textContent = `@keyframes adsSpin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }`;
      document.head.appendChild(style);
    }

    function createLoadingBlocker() {
      if (document.getElementById('ads-loading-blocker')) return;

      try {
        state.prevHtmlOverflow = document.documentElement.style.overflow || '';
        state.prevBodyOverflow = document.body.style.overflow || '';
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      } catch (_) { }

      attachCaptureBlockers();
      ensureSpinStyleOnce();

      const el = document.createElement('div');
      el.id = 'ads-loading-blocker';

      Object.assign(el.style, {
        position: 'fixed',
        inset: '0',
        width: '100%',
        height: '100%',
        zIndex: '2147483647',
        background: 'rgba(0,0,0,0.35)',
        backdropFilter: 'blur(2px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        pointerEvents: 'auto',
        touchAction: 'none'
      });

      el.innerHTML = `
        <div style="
          color:#e5e7eb;
          padding:14px 18px;
          border-radius:14px;
          box-shadow:0 10px 35px rgba(0,0,0,.35);
          font-family: system-ui, -apple-system, Segoe UI, Roboto;
          text-align:center;
          min-width:120px;
        ">
          <div style="
            width:26px;height:26px;
            border-radius:50%;
            border:3px solid #38bdf8;
            border-top-color:transparent;
            margin:0 auto 8px auto;
            animation: adsSpin 0.85s linear infinite;
          "></div>
          <div style="font-size:12px;opacity:.9;">Loadingâ€¦</div>
        </div>
      `;

      document.body.appendChild(el);
    }

    function removeLoadingBlocker() {
      try {
        const el = document.getElementById('ads-loading-blocker');
        if (el) el.remove();
      } catch (_) { }

      try {
        document.documentElement.style.overflow = state.prevHtmlOverflow;
        document.body.style.overflow = state.prevBodyOverflow;
      } catch (_) { }

      removeCaptureBlockers();
    }

    function clearAllTimers() {
      if (state.overallTimer) clearTimeout(state.overallTimer);
      if (state.pollInterval) clearInterval(state.pollInterval);
      state.overallTimer = null;
      state.pollInterval = null;
    }

    function finish() {
      if (state.finished) return;
      state.finished = true;
      state.running = false;
      clearAllTimers();
      removeLoadingBlocker();
    }

    function tryShowWithTimeout(showFn) {
      return new Promise((resolve, reject) => {
        let settled = false;

        const safety = setTimeout(() => {
          if (settled) return;
          settled = true;
          reject(new Error('ad-timeout'));
        }, AD_SHOW_TIMEOUT_MS);

        Promise.resolve()
          .then(() => showFn())
          .then((res) => {
            if (settled) return;
            settled = true;
            clearTimeout(safety);
            resolve(res);
          })
          .catch((err) => {
            if (settled) return;
            settled = true;
            clearTimeout(safety);
            reject(err);
          });
      });
    }

    function runShowFlow() {
      try {
        createLoadingBlocker();

        state.overallTimer = setTimeout(() => {
          finish();
        }, AD_SHOW_TIMEOUT_MS);

        state.pollInterval = setInterval(() => {
          const fn = window[SHOW_FN_NAME];
          if (typeof fn === 'function') {
            clearAllTimers();
            tryShowWithTimeout(fn)
              .then(() => finish())
              .catch(() => finish());
          }
        }, SDK_POLL_INTERVAL_MS);

      } catch (_) {
        finish();
      }
    }

    // Extra safety: if user leaves page / app background, cleanup
    window.addEventListener('pagehide', finish, { once: true });
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) finish();
    });

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runShowFlow, { once: true });
    } else {
      runShowFlow();
    }
  })();
</script>
