<section class="mx-auto w-full max-w-2xl px-4 py-6">
    <!-- HERO -->
    <%- include('../partials/header') %>

        <!-- Page Title -->
        <header class="mt-4">
            <h1 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Inline Buttons Builder</h1>
            <p class="mt-1 text-sm leading-6 text-slate-600 dark:text-slate-300">
                Build Telegram inline keyboard buttons visually and copy the final code to send to the bot.
            </p>
        </header>

        <div class="mt-5 space-y-6">
            <div
                class="rounded-xl bg-slate-50 p-4 text-sm leading-6 text-slate-700 dark:bg-slate-900 dark:text-slate-200">
                <p class="font-medium text-slate-900 dark:text-slate-100">How it works</p>
                <ul class="mt-2 list-disc space-y-1 pl-5">
                    <li>Each <span class="font-medium">row</span> becomes one Telegram keyboard row.</li>
                    <li>Each <span class="font-medium">button</span> needs a Title + Action.</li>
                    <li>
                        The tool generates code using your bot syntax:
                        <span class="font-mono">{ [ Title - action ] [ Title - action ] }</span>.
                    </li>
                </ul>
            </div>

            <div class="space-y-3">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Builder</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="btnAddRow" type="button"
                            class="rounded-lg bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-800 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-white">
                            Add row
                        </button>
                        <button id="btnClearAll" type="button"
                            class="rounded-lg bg-slate-200 px-3 py-2 text-xs font-semibold text-slate-900 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700">
                            Clear
                        </button>
                    </div>
                </div>

                <div id="rows" class="space-y-4"></div>
            </div>

            <div class="space-y-2">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Generated code</h2>
                    <div class="flex flex-wrap gap-2">
                        <button id="btnCopy" type="button"
                            class="rounded-lg bg-emerald-600 px-3 py-2 text-xs font-semibold text-white hover:bg-emerald-700">
                            Copy
                        </button>
                        <button id="btnSelect" type="button"
                            class="rounded-lg bg-slate-200 px-3 py-2 text-xs font-semibold text-slate-900 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700">
                            Select
                        </button>
                    </div>
                </div>

                <textarea id="output" readonly rows="7"
                    class="w-full resize-none rounded-xl border border-slate-200 bg-white p-3 font-mono text-xs leading-5 text-slate-900 shadow-sm outline-none focus:ring-2 focus:ring-slate-300 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:focus:ring-slate-700"
                    placeholder="Your generated button code will appear here..."></textarea>

                <p id="status" class="text-xs leading-5 text-slate-500 dark:text-slate-400"></p>
            </div>

            <div class="space-y-2">
                <h2 class="text-sm font-semibold text-slate-900 dark:text-slate-100">Preview (mock)</h2>
                <div id="preview" class="space-y-2 rounded-xl bg-slate-50 p-3 dark:bg-slate-900"></div>
                <p class="text-xs leading-5 text-slate-500 dark:text-slate-400">
                    This is a visual preview only. Final Telegram layout can vary slightly.
                </p>
            </div>

            <div
                class="rounded-xl bg-amber-50 p-4 text-sm leading-6 text-amber-900 dark:bg-amber-950 dark:text-amber-200">
                <p class="font-medium">Allowed actions (your bot format)</p>
                <ul class="mt-2 list-disc space-y-1 pl-5">
                    <li><span class="font-mono">https://...</span> / <span class="font-mono">http://...</span> / <span
                            class="font-mono">t.me/...</span> / <span class="font-mono">@username</span> / <span
                            class="font-mono">example.com</span> (URL button)</li>
                    <li><span class="font-mono">popup:Your text</span> (shows an alert popup; you can write <span
                            class="font-mono">\n</span> for new lines)</li>
                    <li><span class="font-mono">alert:Your text</span> (shows a small notification)</li>
                    <li><span class="font-mono">share:Your text</span> (opens share with prefilled text)</li>
                    <li><span class="font-mono">copy:Your text</span> (bot sends text so user can copy)</li>
                    <li><span class="font-mono">del:</span> (deletes the message)</li>
                    <li><span class="font-mono">personal:command</span> (runs a bot command, without <span
                            class="font-mono">/</span>)</li>
                </ul>
                <p class="mt-2 text-xs leading-5">Tip: Special actions are detected using the <span
                        class="font-mono">:</span> format.</p>
            </div>
        </div>

        <!-- Templates -->
        <template id="rowTpl">
            <div
                class="rounded-xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-950">
                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="text-sm font-semibold text-slate-900 dark:text-slate-100">
                        Row <span class="rowIndex">1</span>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button type="button"
                            class="btnAddBtn rounded-lg bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-800 dark:bg-slate-100 dark:text-slate-900 dark:hover:bg-white">
                            Add button
                        </button>
                        <button type="button"
                            class="btnRemoveRow rounded-lg bg-slate-200 px-3 py-2 text-xs font-semibold text-slate-900 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700">
                            Remove row
                        </button>
                    </div>
                </div>
                <div class="mt-3 space-y-3 buttons"></div>
            </div>
        </template>

        <template id="btnTpl">
            <div class="grid gap-2 rounded-lg bg-slate-50 p-3 dark:bg-slate-900">
                <div class="grid gap-2 sm:grid-cols-2">
                    <label class="block">
                        <span class="text-xs font-medium text-slate-700 dark:text-slate-200">Title</span>
                        <input type="text"
                            class="title mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-slate-300 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:focus:ring-slate-700"
                            placeholder="e.g. Open Rules" />
                    </label>

                    <label class="block">
                        <span class="text-xs font-medium text-slate-700 dark:text-slate-200">Action type</span>
                        <select
                            class="type mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-slate-300 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:focus:ring-slate-700">
                            <option value="url">URL (https://... or t.me/... or @username)</option>
                            <option value="popup">popup:</option>
                            <option value="alert">alert:</option>
                            <option value="share">share:</option>
                            <option value="copy">copy:</option>
                            <option value="del">del:</option>
                            <option value="personal">personal:</option>
                            <option value="custom">custom (raw)</option>
                        </select>
                    </label>
                </div>

                <label class="block">
                    <span class="text-xs font-medium text-slate-700 dark:text-slate-200">Action value</span>
                    <input type="text"
                        class="value mt-1 w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:ring-2 focus:ring-slate-300 dark:border-slate-700 dark:bg-slate-950 dark:text-slate-100 dark:focus:ring-slate-700"
                        placeholder="Depends on type" />
                    <span class="hint mt-1 block text-xs leading-5 text-slate-500 dark:text-slate-400"></span>
                </label>

                <div class="flex flex-wrap items-center justify-between gap-2">
                    <div class="text-xs text-slate-500 dark:text-slate-400">Tip: Keep titles short for mobile.</div>
                    <button type="button"
                        class="btnRemoveBtn rounded-lg bg-slate-200 px-3 py-2 text-xs font-semibold text-slate-900 hover:bg-slate-300 dark:bg-slate-800 dark:text-slate-100 dark:hover:bg-slate-700">
                        Remove
                    </button>
                </div>

                <p class="err hidden text-xs font-medium text-rose-600"></p>
            </div>
        </template>

        <script>
            (function () {
                // Back bar
                const backBtn = document.getElementById('pageBackBtn');
                function goBack() {
                    if (window.history.length > 1) return window.history.back();
                    return window.location.href = "/<%= token %>/group-help-advance";
                }
                if (backBtn) backBtn.addEventListener('click', goBack);

                // Telegram native back button (optional)
                try {
                    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
                    if (tg?.BackButton) {
                        tg.BackButton.show();
                        tg.BackButton.onClick(goBack);
                    }
                } catch (e) { }

                // Builder code
                const rowsEl = document.getElementById('rows');
                const rowTpl = document.getElementById('rowTpl');
                const btnTpl = document.getElementById('btnTpl');
                const outputEl = document.getElementById('output');
                const previewEl = document.getElementById('preview');
                const statusEl = document.getElementById('status');

                const btnAddRow = document.getElementById('btnAddRow');
                const btnClearAll = document.getElementById('btnClearAll');
                const btnCopy = document.getElementById('btnCopy');
                const btnSelect = document.getElementById('btnSelect');

                const state = { rows: [] };

                function setStatus(msg) {
                    statusEl.textContent = msg || '';
                }

                function escapeTitleIfNeeded(title) {
                    return String(title || '').replaceAll(' - ', ' \\- ');
                }

                function buildAction(type, value) {
                    const v = (value || '').trim();
                    if (type === 'del') return 'del:';
                    if (type === 'custom') return v;
                    if (type === 'url') return v;
                    if (!v) return '';
                    return type + ':' + v;
                }

                function hintFor(type) {
                    switch (type) {
                        case 'url':
                            return 'Examples: https://example.com  OR  t.me/telegram  OR  @username  OR  example.com';
                        case 'popup':
                            return 'Example: This is a popup\\nSecond line';
                        case 'alert':
                            return 'Example: Saved successfully';
                        case 'share':
                            return 'Example: Join our group now!';
                        case 'copy':
                            return 'Example: ABC-123';
                        case 'del':
                            return 'No value needed.';
                        case 'personal':
                            return 'Example: start (without /)';
                        case 'custom':
                            return 'Any raw action string. (Advanced)';
                        default:
                            return '';
                    }
                }

                function createRow() {
                    const row = { buttons: [] };
                    state.rows.push(row);

                    const node = rowTpl.content.firstElementChild.cloneNode(true);
                    const buttonsEl = node.querySelector('.buttons');

                    node.querySelector('.btnAddBtn').addEventListener('click', () => {
                        addButton(row, buttonsEl);
                        render();
                    });

                    node.querySelector('.btnRemoveRow').addEventListener('click', () => {
                        const idx = state.rows.indexOf(row);
                        if (idx > -1) state.rows.splice(idx, 1);
                        node.remove();
                        render();
                    });

                    rowsEl.appendChild(node);
                    addButton(row, buttonsEl, { title: 'Open Rules', type: 'url', value: 'https://example.com' });
                    render();
                }

                function addButton(row, container, initial) {
                    const btn = {
                        title: (initial?.title || ''),
                        type: (initial?.type || 'url'),
                        value: (initial?.value || '')
                    };
                    row.buttons.push(btn);

                    const node = btnTpl.content.firstElementChild.cloneNode(true);
                    const titleEl = node.querySelector('.title');
                    const typeEl = node.querySelector('.type');
                    const valueEl = node.querySelector('.value');
                    const hintEl = node.querySelector('.hint');
                    const errEl = node.querySelector('.err');

                    function validate() {
                        errEl.classList.add('hidden');
                        errEl.textContent = '';

                        const t = (btn.title || '').trim();
                        if (!t) {
                            errEl.textContent = 'Title is required.';
                            errEl.classList.remove('hidden');
                            return false;
                        }

                        const action = buildAction(btn.type, btn.value);
                        if (!action) {
                            errEl.textContent = 'Action is required for this type.';
                            errEl.classList.remove('hidden');
                            return false;
                        }

                        if (btn.type === 'url') {
                            const ok = /^(https?:\/\/|t\.me\/|@|[a-z0-9\-]+\.[a-z]{2,})/i.test(action);
                            if (!ok) {
                                errEl.textContent = 'For URL type, use https://... or t.me/... or @username or example.com';
                                errEl.classList.remove('hidden');
                                return false;
                            }
                        }

                        if (btn.type === 'del' && action !== 'del:') {
                            errEl.textContent = 'Delete action must be exactly: del:';
                            errEl.classList.remove('hidden');
                            return false;
                        }

                        return true;
                    }

                    function sync() {
                        btn.title = titleEl.value;
                        btn.type = typeEl.value;
                        btn.value = valueEl.value;

                        hintEl.textContent = hintFor(btn.type);
                        valueEl.disabled = (btn.type === 'del');
                        if (btn.type === 'del') valueEl.value = '';

                        validate();
                        render();
                    }

                    titleEl.value = btn.title;
                    typeEl.value = btn.type;
                    valueEl.value = btn.value;
                    hintEl.textContent = hintFor(btn.type);
                    valueEl.disabled = (btn.type === 'del');

                    titleEl.addEventListener('input', sync);
                    typeEl.addEventListener('change', sync);
                    valueEl.addEventListener('input', sync);

                    node.querySelector('.btnRemoveBtn').addEventListener('click', () => {
                        const idx = row.buttons.indexOf(btn);
                        if (idx > -1) row.buttons.splice(idx, 1);
                        node.remove();
                        render();
                    });

                    container.appendChild(node);
                }

                function generateCode() {
                    const lines = [];
                    for (const row of state.rows) {
                        const rowBtns = [];
                        for (const b of row.buttons) {
                            const title = escapeTitleIfNeeded((b.title || '').trim());
                            const action = buildAction(b.type, b.value);
                            if (!title || !action) continue;
                            rowBtns.push(`[${title} - ${action}]`);
                        }
                        if (rowBtns.length) lines.push(`{ ${rowBtns.join(' ')} }`);
                    }
                    return lines.join('\n');
                }

                function renderPreview() {
                    previewEl.innerHTML = '';

                    for (const row of state.rows) {
                        const validButtons = row.buttons
                            .map(b => ({ title: (b.title || '').trim(), action: buildAction(b.type, b.value) }))
                            .filter(x => x.title && x.action);

                        if (!validButtons.length) continue;

                        const cols = Math.min(Math.max(validButtons.length, 1), 3);
                        const rowWrap = document.createElement('div');
                        rowWrap.className = 'grid gap-2';
                        rowWrap.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;

                        for (const btn of validButtons) {
                            const el = document.createElement('div');
                            el.className = 'rounded-lg bg-white px-3 py-2 text-center text-sm text-slate-900 shadow-sm dark:bg-slate-800 dark:text-slate-100 break-words';
                            el.textContent = btn.title;
                            rowWrap.appendChild(el);
                        }

                        previewEl.appendChild(rowWrap);
                    }

                    if (!previewEl.children.length) {
                        const empty = document.createElement('div');
                        empty.className = 'text-sm text-slate-500 dark:text-slate-400';
                        empty.textContent = 'Add rows/buttons to see preview.';
                        previewEl.appendChild(empty);
                    }
                }

                function render() {
                    Array.from(rowsEl.children).forEach((rowNode, i) => {
                        const idxEl = rowNode.querySelector('.rowIndex');
                        if (idxEl) idxEl.textContent = String(i + 1);
                    });

                    const code = generateCode();
                    outputEl.value = code;
                    renderPreview();

                    if (!code.trim()) setStatus('Add at least one valid button to generate code.');
                    else setStatus('Copy this code and send it to the bot where it asks for buttons.');
                }

                btnAddRow.addEventListener('click', () => createRow());

                btnClearAll.addEventListener('click', () => {
                    state.rows = [];
                    rowsEl.innerHTML = '';
                    render();
                });

                btnSelect.addEventListener('click', () => {
                    outputEl.focus();
                    outputEl.select();
                    setStatus('Selected. Now copy it.');
                });

                btnCopy.addEventListener('click', async () => {
                    try {
                        const text = outputEl.value || '';
                        if (!text.trim()) return setStatus('Nothing to copy.');

                        if (navigator.clipboard?.writeText) {
                            await navigator.clipboard.writeText(text);
                            setStatus('Copied to clipboard.');
                            return;
                        }

                        outputEl.focus();
                        outputEl.select();
                        document.execCommand('copy');
                        setStatus('Copied (fallback).');
                    } catch (e) {
                        setStatus('Copy failed. Please tap Select and copy manually.');
                    }
                });

                createRow();
            })();
        </script>

        <%- include('../partials/footer') %>
</section>

<script>
    (function () {
        const root = document.documentElement;
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

        function numCssVar(name) {
            const v = getComputedStyle(root).getPropertyValue(name);
            const n = parseFloat(v);
            return Number.isFinite(n) ? n : 0;
        }

        function setSafeVars() {
            let top = 0;
            let bottom = 0;

            // Prefer Telegram provided insets (new clients)
            try {
                top = tg?.safeAreaInset?.top ?? 0;
                bottom = tg?.safeAreaInset?.bottom ?? 0;
            } catch (e) { }

            // Fallback to Telegram CSS vars if present
            if (!top) top = numCssVar('--tg-safe-area-inset-top');
            if (!bottom) bottom = numCssVar('--tg-safe-area-inset-bottom');

            // Last fallback for iOS-like devices if everything is 0
            if (!top && /iPhone|iPad|iPod/i.test(navigator.userAgent)) top = 24;

            root.style.setProperty('--app-safe-top', top + 'px');
            root.style.setProperty('--app-safe-bottom', bottom + 'px');
        }

        setSafeVars();

        // Keep it updated when Telegram reports changes
        try { tg?.onEvent?.('safeAreaChanged', setSafeVars); } catch (e) { }
        try { tg?.onEvent?.('safe_area_changed', setSafeVars); } catch (e) { } // some wrappers emit snake_case [web:203][web:128]

        // Optional: set header/background color so status bar icons look correct in fullscreen [page:1]
        try {
            if (tg?.setHeaderColor && tg?.colorScheme) {
                tg.setHeaderColor(tg.colorScheme === 'dark' ? '#020617' : '#f8fafc');
            }
            if (tg?.setBackgroundColor && tg?.colorScheme) {
                tg.setBackgroundColor(tg.colorScheme === 'dark' ? '#020617' : '#f8fafc');
            }
        } catch (e) { }
    })();

    try {
        function goBack() {
            if (window.history.length > 1) return window.history.back();
            return window.location.href = "/<%= token %>/group-help-advance";
        }
        const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
        if (tg?.BackButton) {
            tg.BackButton.show();
            tg.BackButton.onClick(goBack);
        }
    } catch (e) { }
</script>

<!-- Ads on first page load (client-only) -->
<script>
    (function () {
        const ADS_BLOCK_ID = 'int-20013'; // <-- replace with your AdsGram block id
        const SESSION_KEY = 'group_help_advance_ads_shown_v1';
        const SAFETY_TIMEOUT_MS = 8000;
        let AdController = null;
        let sdkLoaded = false;
        let sdkRequested = false;

        function loadAdsgramSDK() {
            return new Promise((resolve) => {
                if (sdkRequested) {
                    // wait until sdkLoaded becomes true or small timeout
                    const start = Date.now();
                    const check = setInterval(() => {
                        if (sdkLoaded || (Date.now() - start) > 1200) { clearInterval(check); resolve(sdkLoaded); }
                    }, 100);
                    return;
                }
                sdkRequested = true;

                if (window.Adsgram && typeof window.Adsgram.init === 'function') {
                    try {
                        AdController = window.Adsgram.init({ blockId: ADS_BLOCK_ID });
                        sdkLoaded = true;
                        resolve(true);
                        return;
                    } catch (e) {
                        console.error('Adsgram init error:', e);
                    }
                }

                const s = document.createElement('script');
                s.src = 'https://sad.adsgram.ai/js/sad.min.js';
                s.async = true;
                s.onload = function () {
                    try {
                        if (window.Adsgram && typeof window.Adsgram.init === 'function') {
                            AdController = window.Adsgram.init({ blockId: ADS_BLOCK_ID });
                            sdkLoaded = true;
                            resolve(true);
                            return;
                        }
                    } catch (err) {
                        console.error('Adsgram init after load failed:', err);
                    }
                    resolve(false);
                };
                s.onerror = function () {
                    console.error('Failed to load Adsgram SDK.');
                    resolve(false);
                };
                document.head.appendChild(s);

                // fallback resolve after short delay in case onload doesn't fire quickly
                setTimeout(() => { if (!sdkLoaded) resolve(sdkLoaded); }, 1200);
            });
        }

        async function showAdIfNeeded() {
            try {
                // Only show once per session/tab
                if (sessionStorage.getItem(SESSION_KEY)) return;

                // try to load SDK (non-blocking)
                const ready = await loadAdsgramSDK();

                // if no SDK, do nothing
                if (!ready || !AdController || typeof AdController.show !== 'function') return;

                // show ad with safety timeout
                const t = setTimeout(() => {
                    // if ad didn't start / resolve within timeout, just mark shown so we don't retry
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                }, SAFETY_TIMEOUT_MS);

                try {
                    const res = await AdController.show();
                    clearTimeout(t);
                    // mark as shown regardless of completion/skipped to avoid repeat
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                } catch (err) {
                    clearTimeout(t);
                    console.error('Adsgram show error:', err);
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                }
            } catch (e) {
                console.error('Error while attempting to show ad on page load', e);
                try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
            }
        }

        // Run on DOMContentLoaded - ensure page UI is ready first
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showAdIfNeeded);
        } else {
            showAdIfNeeded();
        }
    })();
</script>