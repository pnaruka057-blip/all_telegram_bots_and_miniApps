<!-- Main Wrapper -->
<section class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col min-h-[100svh]">

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto px-6 py-6 space-y-6 animate-background">

    <!-- Profile Section -->
    <div class="flex flex-col items-center text-center space-y-2">
      <img id="profileImg" src="<%= user && user.user_logo ? user.user_logo : '' %>" alt="Profile Picture"
        class="w-24 h-24 rounded-full shadow-lg border">

      <h2 id="nameTitle" class="text-lg font-bold">
        <%= user?.name || '' %>
      </h2>
      <p id="usernameLine" class="text-gray-500">
        <%= user?.username ? '@' + user.username : '' %>
      </p>
      <span id="idLine" class="text-sm text-gray-400">
        <%= user?.user_id ? ('ID: ' + user.user_id) : '' %></span>
    </div>

    <!-- Telegram Info (auto-filled) -->
    <div class="bg-gray-50 border rounded-xl p-4">
      <h3 class="text-sm font-bold text-gray-800 mb-3">Telegram info</h3>

      <div class="space-y-2 text-sm">
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">ID</span>
          <span id="tg_id" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">First name</span>
          <span id="tg_first_name" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Last name</span>
          <span id="tg_last_name" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Username</span>
          <span id="tg_username" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Language code</span>
          <span id="tg_language_code" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Is premium</span>
          <span id="tg_is_premium" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Can write to PM</span>
          <span id="tg_allows_write_to_pm" class="font-semibold text-gray-800 truncate">-</span>
        </div>
      </div>
    </div>

  </main>

   <!-- Navigation / Footer -->
        <%- include('../partials/footer') %>
</section>

<script>
  /**
   * Profile image + Telegram user info
   * Uses Telegram WebApp initDataUnsafe.user if available.
   */
  (function () {
    const FALLBACK = 'https://res.cloudinary.com/dm8miilli/image/upload/v1755791642/profile_hbb9k4.png';

    function setText(id, value, prefix = '') {
      const el = document.getElementById(id);
      if (!el) return;
      const v = (value === undefined || value === null || value === '') ? '-' : String(value);
      el.textContent = prefix ? (v === '-' ? '-' : (prefix + v)) : v;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      try { tg && typeof tg.ready === 'function' && tg.ready(); } catch (e) { }

      const tgUser = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;

      // Image
      try {
        const img = document.getElementById('profileImg');
        if (img) {
          const initialSrc = (img.getAttribute('src') || '').trim();
          if (!initialSrc) {
            if (tgUser && tgUser.photo_url) img.src = tgUser.photo_url;
            else img.src = FALLBACK;
          }
        }
      } catch (e) { }

      // Fill Telegram info
      if (tgUser) {
        setText('tg_id', tgUser.id);
        setText('tg_first_name', tgUser.first_name);
        setText('tg_last_name', tgUser.last_name);
        setText('tg_username', tgUser.username, '@');
        setText('tg_language_code', tgUser.language_code);
        setText('tg_is_premium', tgUser.is_premium);
        setText('tg_allows_write_to_pm', tgUser.allows_write_to_pm);

        // Optional: if server-side name/username missing, fill header too
        const nameTitle = document.getElementById('nameTitle');
        if (nameTitle && (!nameTitle.textContent || !nameTitle.textContent.trim())) {
          nameTitle.textContent = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') || 'User';
        }
        const usernameLine = document.getElementById('usernameLine');
        if (usernameLine && (!usernameLine.textContent || !usernameLine.textContent.trim())) {
          usernameLine.textContent = tgUser.username ? ('@' + tgUser.username) : '';
        }
        const idLine = document.getElementById('idLine');
        if (idLine && (!idLine.textContent || !idLine.textContent.trim())) {
          idLine.textContent = tgUser.id ? ('ID: ' + tgUser.id) : '';
        }
      } else {
        // No Telegram data: keep '-' and just ensure image fallback
        try {
          const img = document.getElementById('profileImg');
          if (img && !(img.getAttribute('src') || '').trim()) img.src = FALLBACK;
        } catch (e) { }
      }
    });
  })();
</script>


<!-- Monetag: auto-show rewarded interstitial (silent failures) -->
<script>
  (function () {
    // CONFIG
    const SHOW_FN_NAME = 'show_10401286'; // agar tumhara function alag name ho to yahan change kar do
    const AD_SHOW_TIMEOUT_MS = 8000;      // ad show promise ke liye safety timeout
    const SDK_POLL_INTERVAL_MS = 500;     // agar SDK thoda late load ho to poll karega
    const SDK_POLL_MAX_ATTEMPTS = 8;      // maximum attempts to find the function

    function tryShowWithTimeout(showFn) {
      return new Promise((resolve, reject) => {
        let settled = false;
        const safety = setTimeout(() => {
          if (settled) return;
          settled = true;
          // swallow timeout as failure
          reject(new Error('ad-timeout'));
        }, AD_SHOW_TIMEOUT_MS);

        // call the show function (it returns a promise in Monetag example)
        Promise.resolve()
          .then(() => showFn())
          .then((res) => {
            if (settled) return;
            settled = true;
            clearTimeout(safety);
            resolve(res);
          })
          .catch((err) => {
            if (settled) return;
            settled = true;
            clearTimeout(safety);
            reject(err);
          });
      });
    }

    function silentNoop() {
      // intentionally empty: no UI, no alert, no console error output to user
    }

    function runShowFlow() {
      try {
        const globalFn = window[SHOW_FN_NAME];
        if (typeof globalFn === 'function') {
          // try show, but swallow any error or timeout silently
          tryShowWithTimeout(globalFn).then(() => {
            // success -> perform any silent post-ad action here if needed
            // e.g. call a reward function (but don't alert)
            // rewardUser(); // optional
          }).catch(() => {
            // swallow
          });
          return;
        }

        // If function not yet present, poll a few times (SDK might be loaded async)
        let attempts = 0;
        const iv = setInterval(() => {
          attempts++;
          const fnNow = window[SHOW_FN_NAME];
          if (typeof fnNow === 'function') {
            clearInterval(iv);
            tryShowWithTimeout(fnNow).catch(() => { /* swallow */ });
            return;
          }
          if (attempts >= SDK_POLL_MAX_ATTEMPTS) {
            clearInterval(iv);
            // give up silently
          }
        }, SDK_POLL_INTERVAL_MS);
      } catch (e) {
        // final guard: swallow everything
        try { silentNoop(); } catch (e2) { }
      }
    }

    // Run on DOM ready (non-blocking)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runShowFlow);
    } else {
      runShowFlow();
    }
  })();
</script>