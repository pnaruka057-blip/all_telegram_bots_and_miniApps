<!-- Main Wrapper -->
<section class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col min-h-[100svh]">

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto px-6 py-6 space-y-6 animate-background">

    <!-- Profile Section -->
    <div class="flex flex-col items-center text-center space-y-2">
      <img id="profileImg" src="<%= user && user.user_logo ? user.user_logo : '' %>" alt="Profile Picture"
        class="w-24 h-24 rounded-full shadow-lg border">

      <h2 id="nameTitle" class="text-lg font-bold">
        <%= user?.name || '' %>
      </h2>
      <p id="usernameLine" class="text-gray-500">
        <%= user?.username ? '@' + user.username : '' %>
      </p>
      <span id="idLine" class="text-sm text-gray-400">
        <%= user?.user_id ? ('ID: ' + user.user_id) : '' %></span>
    </div>

    <!-- Telegram Info (auto-filled) -->
    <div class="bg-gray-50 border rounded-xl p-4">
      <h3 class="text-sm font-bold text-gray-800 mb-3">Telegram info</h3>

      <div class="space-y-2 text-sm">
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">ID</span>
          <span id="tg_id" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">First name</span>
          <span id="tg_first_name" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Last name</span>
          <span id="tg_last_name" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Username</span>
          <span id="tg_username" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Language code</span>
          <span id="tg_language_code" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Is premium</span>
          <span id="tg_is_premium" class="font-semibold text-gray-800 truncate">-</span>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-gray-500">Can write to PM</span>
          <span id="tg_allows_write_to_pm" class="font-semibold text-gray-800 truncate">-</span>
        </div>
      </div>
    </div>

  </main>

   <!-- Navigation / Footer -->
        <%- include(' ../partials/footer') %>
</section>

<script>
  /**
   * Profile image + Telegram user info
   * Uses Telegram WebApp initDataUnsafe.user if available.
   */
  (function () {
    const FALLBACK = 'https://res.cloudinary.com/dm8miilli/image/upload/v1755791642/profile_hbb9k4.png';

    function setText(id, value, prefix = '') {
      const el = document.getElementById(id);
      if (!el) return;
      const v = (value === undefined || value === null || value === '') ? '-' : String(value);
      el.textContent = prefix ? (v === '-' ? '-' : (prefix + v)) : v;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
      try { tg && typeof tg.ready === 'function' && tg.ready(); } catch (e) { }

      const tgUser = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;

      // Image
      try {
        const img = document.getElementById('profileImg');
        if (img) {
          const initialSrc = (img.getAttribute('src') || '').trim();
          if (!initialSrc) {
            if (tgUser && tgUser.photo_url) img.src = tgUser.photo_url;
            else img.src = FALLBACK;
          }
        }
      } catch (e) { }

      // Fill Telegram info
      if (tgUser) {
        setText('tg_id', tgUser.id);
        setText('tg_first_name', tgUser.first_name);
        setText('tg_last_name', tgUser.last_name);
        setText('tg_username', tgUser.username, '@');
        setText('tg_language_code', tgUser.language_code);
        setText('tg_is_premium', tgUser.is_premium);
        setText('tg_allows_write_to_pm', tgUser.allows_write_to_pm);

        // Optional: if server-side name/username missing, fill header too
        const nameTitle = document.getElementById('nameTitle');
        if (nameTitle && (!nameTitle.textContent || !nameTitle.textContent.trim())) {
          nameTitle.textContent = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') || 'User';
        }
        const usernameLine = document.getElementById('usernameLine');
        if (usernameLine && (!usernameLine.textContent || !usernameLine.textContent.trim())) {
          usernameLine.textContent = tgUser.username ? ('@' + tgUser.username) : '';
        }
        const idLine = document.getElementById('idLine');
        if (idLine && (!idLine.textContent || !idLine.textContent.trim())) {
          idLine.textContent = tgUser.id ? ('ID: ' + tgUser.id) : '';
        }
      } else {
        // No Telegram data: keep '-' and just ensure image fallback
        try {
          const img = document.getElementById('profileImg');
          if (img && !(img.getAttribute('src') || '').trim()) img.src = FALLBACK;
        } catch (e) { }
      }
    });
  })();
</script>

<!-- Monetag: strict blocking + visible loader -->
<script>
  (function () {

    const SHOW_FN_NAME = 'show_10401286';
    const AD_SHOW_TIMEOUT_MS = 30000;
    const SDK_POLL_INTERVAL_MS = 500;

    let overallTimer = null;
    let pollInterval = null;
    let blockerAttached = false;

    let prevHtmlOverflow = '';
    let prevBodyOverflow = '';

    function stopper(e) {
      try {
        e.stopImmediatePropagation();
        e.preventDefault();
      } catch (_) { }
      return false;
    }

    function attachCaptureBlockers() {
      if (blockerAttached) return;
      blockerAttached = true;

      document.addEventListener('click', stopper, true);
      document.addEventListener('pointerdown', stopper, true);
      document.addEventListener('touchstart', stopper, true);
      document.addEventListener('wheel', stopper, { capture: true, passive: false });
      document.addEventListener('keydown', stopper, true);
    }

    function removeCaptureBlockers() {
      if (!blockerAttached) return;
      blockerAttached = false;

      document.removeEventListener('click', stopper, true);
      document.removeEventListener('pointerdown', stopper, true);
      document.removeEventListener('touchstart', stopper, true);
      document.removeEventListener('wheel', stopper, { capture: true, passive: false });
      document.removeEventListener('keydown', stopper, true);
    }

    function createLoadingBlocker() {
      if (document.getElementById('ads-loading-blocker')) return;

      try {
        prevHtmlOverflow = document.documentElement.style.overflow || '';
        prevBodyOverflow = document.body.style.overflow || '';
        document.documentElement.style.overflow = 'hidden';
        document.body.style.overflow = 'hidden';
      } catch (_) { }

      attachCaptureBlockers();

      const el = document.createElement('div');
      el.id = 'ads-loading-blocker';

      Object.assign(el.style, {
        position: 'fixed',
        inset: '0',
        width: '100%',
        height: '100%',
        zIndex: '2147483647',
        background: 'rgba(0,0,0,0.35)',
        backdropFilter: 'blur(2px)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        pointerEvents: 'auto',
        touchAction: 'none'
      });

      // ---- Loader UI ----
      el.innerHTML = `
      <div style="
        color:#e5e7eb;
        padding:14px 18px;
        border-radius:14px;
        box-shadow:0 10px 35px rgba(0,0,0,.35);
        font-family: system-ui, -apple-system, Segoe UI, Roboto;
        text-align:center;
        min-width:120px;
      ">
        <div style="
          width:26px;height:26px;
          border-radius:50%;
          border:3px solid #38bdf8;
          border-top-color:transparent;
          margin:0 auto 8px auto;
          animation: adsSpin 0.85s linear infinite;
        "></div>
        <div style="font-size:12px;opacity:.9;">
          Loadingâ€¦
        </div>
      </div>
    `;

      // animation keyframes
      const style = document.createElement('style');
      style.textContent = `
      @keyframes adsSpin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    `;
      document.head.appendChild(style);

      document.body.appendChild(el);
    }

    function removeLoadingBlocker() {
      try {
        const el = document.getElementById('ads-loading-blocker');
        if (el) el.remove();
      } catch (_) { }

      try {
        document.documentElement.style.overflow = prevHtmlOverflow;
        document.body.style.overflow = prevBodyOverflow;
      } catch (_) { }

      removeCaptureBlockers();
    }

    function clearAllTimers() {
      if (overallTimer) clearTimeout(overallTimer);
      if (pollInterval) clearInterval(pollInterval);
      overallTimer = null;
      pollInterval = null;
    }

    function tryShowWithTimeout(showFn) {
      return new Promise((resolve, reject) => {
        let settled = false;

        const safety = setTimeout(() => {
          if (settled) return;
          settled = true;
          reject(new Error('ad-timeout'));
        }, AD_SHOW_TIMEOUT_MS);

        Promise.resolve()
          .then(() => showFn())
          .then(res => {
            if (settled) return;
            settled = true;
            clearTimeout(safety);
            resolve(res);
          })
          .catch(err => {
            if (settled) return;
            settled = true;
            clearTimeout(safety);
            reject(err);
          });
      });
    }

    function runShowFlow() {
      try {
        createLoadingBlocker();

        // overall watchdog
        overallTimer = setTimeout(() => {
          clearAllTimers();
          removeLoadingBlocker();
        }, AD_SHOW_TIMEOUT_MS);

        // keep polling until function appears OR timeout hits
        pollInterval = setInterval(() => {
          const fn = window[SHOW_FN_NAME];
          if (typeof fn === 'function') {
            clearAllTimers();

            tryShowWithTimeout(fn)
              .then(() => removeLoadingBlocker())
              .catch(() => removeLoadingBlocker());
          }
        }, SDK_POLL_INTERVAL_MS);

      } catch (_) {
        clearAllTimers();
        removeLoadingBlocker();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runShowFlow);
    } else {
      runShowFlow();
    }

  })();
</script>