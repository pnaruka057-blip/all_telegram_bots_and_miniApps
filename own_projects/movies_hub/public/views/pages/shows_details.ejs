<!-- Main Wrapper -->
<section class="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col min-h-[100svh]">

    <!-- Show Thumbnail with vertical scroll animation -->
    <div class="relative w-full max-h-[350px] overflow-hidden rounded-lg">
        <img src="<%= updatedShowDetails.thumbnail %>" alt="<%= updatedShowDetails.title %>"
            class="w-full h-auto object-contain animate-verticalScroll">
    </div>

    <!-- Main Content -->
    <main id="contentGrid" class="flex-1 overflow-y-auto px-6 py-4 bg-gray-50">

        <!-- Title -->
        <h1 class="text-xl font-bold text-gray-800 leading-tight">
            <%= updatedShowDetails.title %>
        </h1>

        <!-- Genre -->
        <p class="mt-2 text-sm text-gray-700">
            üé≠ <%= updatedShowDetails.genre %>
        </p>

        <!-- Category -->
        <span class="mt-2 inline-block px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs font-medium">
            <%= updatedShowDetails.category %>
        </span>

        <!-- Seasons -->
        <div class="mt-5">
            <h2 class="text-md font-semibold text-gray-800 mb-3">üì∫ Seasons</h2>

            <% updatedShowDetails.series.forEach((season, seasonIndex)=> { %>
                <div class="mb-6 p-4 bg-white rounded-lg shadow">

                    <!-- Season Header -->
                    <div class="mb-3">
                        <span class="font-semibold text-gray-800">Season <%= seasonIndex + 1 %></span>
                        <p class="text-xs text-gray-600 mt-1">üìÖ Release: <%= season.release_date %>
                        </p>

                        <!-- Languages -->
                        <div class="mt-2 flex flex-wrap gap-2">
                            <% season.language.split(",").forEach(lang=> { %>
                                <span class="px-2 py-1 bg-green-100 text-green-600 text-xs rounded-full">
                                    <%= lang.trim() %>
                                </span>
                                <% }) %>
                        </div>
                    </div>

                    <!-- Download Links by Quality -->
                    <% season.quality.forEach((q, i)=> { %>
                        <button class="download-btn block w-full text-center py-2 mb-2 bg-purple-600 text-white rounded-lg
                                shadow hover:bg-purple-700 transition" data-url="<%= season.download_link[i] %>"
                            data-show-id="<%= updatedShowDetails._id %>">
                            ‚¨áÔ∏è Download <%= q %>
                        </button>
                        <% }) %>
                </div>
                <% }) %>
        </div>

    </main>

    <!-- Footer -->
    <%- include('../partials/footer') %>
</section>

<script>
    document.querySelectorAll(".download-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const originalUrl = btn.dataset.url;
            const showId = btn.dataset.showId;

            try {
                const res = await axios.post("/<%= token %>/movies-hub/get_shortlink", {
                    url: originalUrl,
                    show_id: showId,
                    fromId: "<%= fromId %>",
                });

                if (res.data && res.data.success && res.data.short_link) {
                    window.open(res.data.short_link, "_blank", "noopener,noreferrer");
                } else {
                    alert("Error: Could not generate shortlink.");
                }
            } catch (err) {
                console.error("Shortlink error:", err);
                alert("Failed to generate shortlink. Please try again.");
            }
        });
    });
</script>

<!-- Ads-on-render (client-only) -->
<script>
    (function () {
        /**
         * Client-only AdsGram ad-on-render.
         *
         * Replace ADS_BLOCK_ID with your AdsGram block id.
         * This script attempts to show an ad once per session/tab for this movie page.
         * It will not block page functionality if SDK/ad does not load or fails.
         */

        const ADS_BLOCK_ID = 'int-20013'; // <-- CHANGE THIS
        const SESSION_KEY = 'ads_shown_movie_<%= updatedMovieDetails._id %>_v1';
        const SDK_LOAD_TIMEOUT = 1500;        // ms to wait for SDK to initialize
        const SHOW_SAFETY_TIMEOUT = 8000;     // ms to fallback if ad hangs

        let AdController = null;
        let sdkRequested = false;
        let sdkInitialized = false;

        function loadAdsgramSDK() {
            return new Promise((resolve) => {
                if (sdkRequested) {
                    // poll until initialized or short timeout
                    const start = Date.now();
                    const poll = setInterval(() => {
                        if (sdkInitialized || (Date.now() - start) > SDK_LOAD_TIMEOUT) {
                            clearInterval(poll);
                            resolve(sdkInitialized);
                        }
                    }, 80);
                    return;
                }
                sdkRequested = true;

                // If already available on window, try init
                if (window.Adsgram && typeof window.Adsgram.init === 'function') {
                    try {
                        AdController = window.Adsgram.init({ blockId: ADS_BLOCK_ID });
                        sdkInitialized = true;
                        resolve(true);
                        return;
                    } catch (e) {
                        console.error('Adsgram init error (existing):', e);
                    }
                }

                // Dynamically insert SDK script
                const s = document.createElement('script');
                s.src = 'https://sad.adsgram.ai/js/sad.min.js';
                s.async = true;
                s.onload = function () {
                    try {
                        if (window.Adsgram && typeof window.Adsgram.init === 'function') {
                            AdController = window.Adsgram.init({ blockId: ADS_BLOCK_ID });
                            sdkInitialized = true;
                            resolve(true);
                            return;
                        }
                    } catch (e) {
                        console.error('Adsgram init failed after load:', e);
                    }
                    resolve(false);
                };
                s.onerror = function () {
                    console.error('Failed to load Adsgram SDK.');
                    resolve(false);
                };
                document.head.appendChild(s);

                // safety resolve after short timeout
                setTimeout(() => { if (!sdkInitialized) resolve(sdkInitialized); }, SDK_LOAD_TIMEOUT);
            });
        }

        async function showAdOnce() {
            try {
                // Only show once per session/tab for this movie
                if (sessionStorage.getItem(SESSION_KEY)) return;

                // Attempt to load/initialize SDK
                const ready = await loadAdsgramSDK();
                if (!ready || !AdController || typeof AdController.show !== 'function') {
                    // mark as shown so we don't retry repeatedly in same session
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                    return;
                }

                // Safety fallback ensures page won't hang if ad never resolves
                let navigatedOrMarked = false;
                const markShown = () => {
                    if (navigatedOrMarked) return;
                    navigatedOrMarked = true;
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                };
                const safetyTimer = setTimeout(() => {
                    console.warn('Ads show did not resolve within safety timeout.');
                    markShown();
                }, SHOW_SAFETY_TIMEOUT);

                try {
                    const res = await AdController.show();
                    clearTimeout(safetyTimer);
                    // Mark as shown regardless of completion/skipped
                    markShown();
                    // You may inspect res.done if you want to award client-only coins, etc.
                } catch (err) {
                    clearTimeout(safetyTimer);
                    console.error('Error while showing Adsgram ad:', err);
                    markShown();
                }
            } catch (e) {
                console.error('Ads-on-render unexpected error:', e);
                try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (err) { }
            }
        }

        // Run when DOM is ready (non-blocking)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showAdOnce);
        } else {
            // Already ready
            showAdOnce();
        }

    })();
</script>