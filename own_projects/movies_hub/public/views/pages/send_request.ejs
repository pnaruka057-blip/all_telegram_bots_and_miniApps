<!-- Main Wrapper -->
<section class="w-full max-w-sm bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col min-h-[100svh]">
    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto px-6 py-6 space-y-6 bg-gray-50 animate-background">

        <form id="requestForm" class="space-y-5">

            <!-- Type Selection (Locked) -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                <div class="flex items-center space-x-4">
                    <label class="flex items-center">
                        <input class="mr-2" type="radio" name="type" value="movie" <%=type==="movie" ? "checked" : "" %>
                        <span>Movie</span>
                    </label>
                    <label class="flex items-center">
                        <input class="mr-2" type="radio" name="type" value="show" <%=type==="show" ? "checked" : "" %>
                        <span>Show</span>
                    </label>
                </div>
            </div>

            <!-- Requested Title -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Requested Title</label>
                <% if (query) { %>
                    <input type="text" name="title" value="<%= query %>" readonly
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 cursor-not-allowed">
                    <% } else { %>
                        <input placeholder="Enter your movie or show name" type="text" name="title"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <% } %>

            </div>

            <!-- User Info -->
            <% if (user) { %>
                <div class="p-4 border rounded-lg bg-white shadow-sm space-y-1">
                    <p class="text-sm text-gray-700"><strong>Name:</strong>
                        <%= user.name %>
                    </p>
                    <p class="text-sm text-gray-700"><strong>User ID:</strong>
                        <%= user_id %>
                    </p>
                    <p class="text-sm text-gray-700"><strong>Username:</strong> @<%= user.username %>
                    </p>
                </div>
                <% } %>

                    <!-- Language Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                        <select name="language"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <% const langs=["Hindi","English","Tamil","Telugu","Kannada","Malayalam"]; %>
                                <% langs.forEach(lang=> { %>
                                    <option value="<%= lang %>" <%=user && user.language===lang ? "selected" : "" %>>
                                        <%= lang %>
                                    </option>
                                    <% }) %>
                        </select>
                    </div>

                    <!-- Hidden Inputs -->
                    <!-- Hidden Inputs -->
                    <input type="hidden" name="user_id" value="<%= user ? user_id : '' %>">

                    <% if (type) { %>
                        <input type="hidden" name="type" value="<%= type %>">
                        <% } %>
                            <!-- Buttons -->
                            <div class="flex items-center justify-between space-x-3">
                                <!-- Submit -->
                                <button id="submitBtn" type="submit"
                                    class="flex-1 flex items-center justify-center space-x-2 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">
                                    <span>Send Request</span>
                                    <svg id="submitLoader" class="w-5 h-5 animate-spin text-white hidden"
                                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                            stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor"
                                            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z">
                                        </path>
                                    </svg>
                                </button>
                            </div>
        </form>
    </main>

    <%- include('../partials/footer') %>

        <!-- Full Page Loader -->
        <div id="pageLoader" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="flex flex-col items-center space-y-4">
                <svg class="animate-spin h-12 w-12 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
                <span class="text-white text-lg">Loading...</span>
            </div>
        </div>
</section>

<script>
    document.getElementById("requestForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const payload = Object.fromEntries(formData.entries());

        // Validation: check if any required field is empty
        const requiredFields = ["title", "type", "language", "user_id"];
        let emptyFields = requiredFields.filter(field => !payload[field] || payload[field].trim() === "");

        if (emptyFields.length > 0) {
            alert("All fields are required!");
            return; // stop submission
        }

        const btn = document.getElementById("submitBtn");
        const loader = document.getElementById("submitLoader");
        btn.disabled = true;
        loader.classList.remove("hidden");

        try {
            const res = await axios.post("/<%= token %>/movies-hub/send-request", payload);
            if (res.data.success) {
                alert("Request sent successfully!");
                this.reset();
            } else {
                alert("Failed to send request.");
            }
        } catch (err) {
            console.error("Error sending request:", err);
            alert("Something went wrong! " + (err.message || "Please try again later."));
        } finally {
            btn.disabled = false;
            loader.classList.add("hidden");
        }
    });
</script>

<!-- Monetag: strict blocking + visible loader -->
<script>
    (function () {

        const SHOW_FN_NAME = 'show_10401286';
        const AD_SHOW_TIMEOUT_MS = 30000;
        const SDK_POLL_INTERVAL_MS = 500;

        let overallTimer = null;
        let pollInterval = null;
        let blockerAttached = false;

        let prevHtmlOverflow = '';
        let prevBodyOverflow = '';

        function stopper(e) {
            try {
                e.stopImmediatePropagation();
                e.preventDefault();
            } catch (_) { }
            return false;
        }

        function attachCaptureBlockers() {
            if (blockerAttached) return;
            blockerAttached = true;

            document.addEventListener('click', stopper, true);
            document.addEventListener('pointerdown', stopper, true);
            document.addEventListener('touchstart', stopper, true);
            document.addEventListener('wheel', stopper, { capture: true, passive: false });
            document.addEventListener('keydown', stopper, true);
        }

        function removeCaptureBlockers() {
            if (!blockerAttached) return;
            blockerAttached = false;

            document.removeEventListener('click', stopper, true);
            document.removeEventListener('pointerdown', stopper, true);
            document.removeEventListener('touchstart', stopper, true);
            document.removeEventListener('wheel', stopper, { capture: true, passive: false });
            document.removeEventListener('keydown', stopper, true);
        }

        function createLoadingBlocker() {
            if (document.getElementById('ads-loading-blocker')) return;

            try {
                prevHtmlOverflow = document.documentElement.style.overflow || '';
                prevBodyOverflow = document.body.style.overflow || '';
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';
            } catch (_) { }

            attachCaptureBlockers();

            const el = document.createElement('div');
            el.id = 'ads-loading-blocker';

            Object.assign(el.style, {
                position: 'fixed',
                inset: '0',
                width: '100%',
                height: '100%',
                zIndex: '2147483647',
                background: 'rgba(0,0,0,0.35)',
                backdropFilter: 'blur(2px)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                pointerEvents: 'auto',
                touchAction: 'none'
            });

            // ---- Loader UI ----
            el.innerHTML = `
      <div style="
        color:#e5e7eb;
        padding:14px 18px;
        border-radius:14px;
        box-shadow:0 10px 35px rgba(0,0,0,.35);
        font-family: system-ui, -apple-system, Segoe UI, Roboto;
        text-align:center;
        min-width:120px;
      ">
        <div style="
          width:26px;height:26px;
          border-radius:50%;
          border:3px solid #38bdf8;
          border-top-color:transparent;
          margin:0 auto 8px auto;
          animation: adsSpin 0.85s linear infinite;
        "></div>
        <div style="font-size:12px;opacity:.9;">
          Loadingâ€¦
        </div>
      </div>
    `;

            // animation keyframes
            const style = document.createElement('style');
            style.textContent = `
      @keyframes adsSpin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    `;
            document.head.appendChild(style);

            document.body.appendChild(el);
        }

        function removeLoadingBlocker() {
            try {
                const el = document.getElementById('ads-loading-blocker');
                if (el) el.remove();
            } catch (_) { }

            try {
                document.documentElement.style.overflow = prevHtmlOverflow;
                document.body.style.overflow = prevBodyOverflow;
            } catch (_) { }

            removeCaptureBlockers();
        }

        function clearAllTimers() {
            if (overallTimer) clearTimeout(overallTimer);
            if (pollInterval) clearInterval(pollInterval);
            overallTimer = null;
            pollInterval = null;
        }

        function tryShowWithTimeout(showFn) {
            return new Promise((resolve, reject) => {
                let settled = false;

                const safety = setTimeout(() => {
                    if (settled) return;
                    settled = true;
                    reject(new Error('ad-timeout'));
                }, AD_SHOW_TIMEOUT_MS);

                Promise.resolve()
                    .then(() => showFn())
                    .then(res => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        resolve(res);
                    })
                    .catch(err => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        reject(err);
                    });
            });
        }

        function runShowFlow() {
            try {
                createLoadingBlocker();

                // overall watchdog
                overallTimer = setTimeout(() => {
                    clearAllTimers();
                    removeLoadingBlocker();
                }, AD_SHOW_TIMEOUT_MS);

                // keep polling until function appears OR timeout hits
                pollInterval = setInterval(() => {
                    const fn = window[SHOW_FN_NAME];
                    if (typeof fn === 'function') {
                        clearAllTimers();

                        tryShowWithTimeout(fn)
                            .then(() => removeLoadingBlocker())
                            .catch(() => removeLoadingBlocker());
                    }
                }, SDK_POLL_INTERVAL_MS);

            } catch (_) {
                clearAllTimers();
                removeLoadingBlocker();
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runShowFlow);
        } else {
            runShowFlow();
        }

    })();
</script>