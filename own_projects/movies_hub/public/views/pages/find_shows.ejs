<!-- Main Wrapper -->
<section class="w-full max-w-sm mx-auto bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col min-h-[100svh]">
    <!-- Main Content: Grid -->
    <main id="contentGrid"
        class="flex-1 overflow-y-auto px-6 py-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 bg-gray-50 animate-background content-start">

        <% const shimmerCount=shows && shows.length> 0 ? shows.length : 8; %>
            <% for (let i=0; i < shimmerCount; i++) { %>
                <div class="bg-white shadow-md rounded-lg overflow-hidden animate-pulse p-1">
                    <!-- Image placeholder -->
                    <div class="w-full h-[200px] bg-gray-300 rounded-lg mb-3"></div>
                    <!-- Title placeholder -->
                    <div class="h-4 bg-gray-300 rounded w-3/4 mx-auto mb-2"></div>
                    <!-- Language/genre placeholder -->
                    <div class="h-3 bg-gray-300 rounded w-1/2 mx-auto mb-2"></div>
                    <!-- Category placeholder -->
                    <div class="h-3 bg-gray-300 rounded w-1/3 mx-auto"></div>
                </div>
                <% } %>
    </main>

    <!-- Pagination -->
    <footer id="pagination" class="px-6 py-3 flex justify-center space-x-2 bg-white"></footer>

    <!-- Navigation / Footer -->
    <div class="mt-auto">
        <%- include('../partials/footer') %>
    </div>
</section>

<script>
    const contentGrid = document.getElementById('contentGrid');
    const footer = document.getElementById('pagination');

    let type = 'show';
    let category = '';
    let currentPage = 1;
    let searchQuery = "<%= show_query %>";

    document.addEventListener("DOMContentLoaded", () => {
        fetchContent(currentPage);
    });

    // Fetch shows
    async function fetchContent(page = 1) {
        currentPage = page;
        try {
            const url = `/<%= token %>/movies-hub/search?type=${type}&search=${encodeURIComponent(searchQuery)}&category=${encodeURIComponent(category)}&page=${page}&fromId=<%= fromId %>`;
            const res = await axios.get(url);

            const { success, shows, totalPages } = res.data;

            if (!success || !shows || shows.length === 0) {
                contentGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full">No shows found.</p>`;
                footer.innerHTML = "";
                return;
            }

            // Render shows
            contentGrid.innerHTML = shows.map(show => {
                // collect languages from all seasons
                let langs = [];
                (show.series || []).forEach(season => {
                    if (season.language) langs.push(season.language);
                });
                langs = [...new Set(langs.join(",").split(",").map(l => l.trim()).filter(Boolean))];

                return `
          <a href="/<%= token %>/movies-hub/show_details?userId=<%= user_id %>&show_id=${show._id}&fromId=<%= fromId %>"
             class="content-item bg-white shadow-md rounded-lg overflow-hidden hover:shadow-xl transition p-1 flex flex-col"
             data-type="show">
            <div class="w-full h-[200px] bg-gray-200 overflow-hidden rounded-lg">
              <img src="${show.thumbnail}" alt="${show.title}" class="w-full h-full object-cover">
            </div>
            <div class="p-3 text-center flex-1">
              <!-- Title: allow wrap, card height auto grows -->
              <h2 class="text-sm font-bold text-gray-800 leading-snug break-words">${show.title}</h2>
              <div class="flex flex-wrap justify-center gap-2 mt-2">
                ${langs.map(lang => `
                  <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-600 rounded-full">${lang}</span>
                `).join("")}
              </div>
              <p class="text-xs text-gray-600 mt-2 break-words">${show.genre || ''}</p>
              <p class="text-xs text-purple-500 mt-1 font-semibold break-words">${show.category || ''}</p>
            </div>
          </a>`;
            }).join("");

            renderPagination(totalPages);

        } catch (err) {
            console.error("Error fetching shows:", err);
            contentGrid.innerHTML = `<p class="text-center text-red-500 col-span-full">Error loading shows.</p>`;
            footer.innerHTML = "";
        }
    }

    // Pagination rendering
    function renderPagination(totalPages) {
        footer.innerHTML = "";
        if (!totalPages || totalPages <= 1) return;

        if (currentPage > 1) {
            footer.innerHTML += `<a href="#" data-page="${currentPage - 1}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Prev</a>`;
        }

        let tokens = [];
        if (totalPages <= 5) {
            for (let i = 1; i <= totalPages; i++) tokens.push(i);
        } else {
            if (currentPage <= 3) tokens = [1, 2, 3, '...', totalPages];
            else if (currentPage >= totalPages - 2) tokens = [1, '...', totalPages - 2, totalPages - 1, totalPages];
            else tokens = [1, '...', currentPage, '...', totalPages];
        }

        tokens.forEach(token => {
            if (token === '...') {
                footer.innerHTML += `<span class="px-3 py-1 text-gray-500">...</span>`;
            } else {
                const isActive = token === currentPage;
                footer.innerHTML += `<a href="#" data-page="${token}" class="px-3 py-1 rounded ${isActive ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}">${token}</a>`;
            }
        });

        if (currentPage < totalPages) {
            footer.innerHTML += `<a href="#" data-page="${currentPage + 1}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>`;
        }

        footer.querySelectorAll('a[data-page]').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const page = parseInt(link.dataset.page);
                if (!isNaN(page)) fetchContent(page);
            });
        });
    }
</script>

<!-- Monetag: strict blocking + visible loader -->
<script>
    (function () {

        const SHOW_FN_NAME = 'show_10401286';
        const AD_SHOW_TIMEOUT_MS = 30000;
        const SDK_POLL_INTERVAL_MS = 500;

        let overallTimer = null;
        let pollInterval = null;
        let blockerAttached = false;

        let prevHtmlOverflow = '';
        let prevBodyOverflow = '';

        function stopper(e) {
            try {
                e.stopImmediatePropagation();
                e.preventDefault();
            } catch (_) { }
            return false;
        }

        function attachCaptureBlockers() {
            if (blockerAttached) return;
            blockerAttached = true;

            document.addEventListener('click', stopper, true);
            document.addEventListener('pointerdown', stopper, true);
            document.addEventListener('touchstart', stopper, true);
            document.addEventListener('wheel', stopper, { capture: true, passive: false });
            document.addEventListener('keydown', stopper, true);
        }

        function removeCaptureBlockers() {
            if (!blockerAttached) return;
            blockerAttached = false;

            document.removeEventListener('click', stopper, true);
            document.removeEventListener('pointerdown', stopper, true);
            document.removeEventListener('touchstart', stopper, true);
            document.removeEventListener('wheel', stopper, { capture: true, passive: false });
            document.removeEventListener('keydown', stopper, true);
        }

        function createLoadingBlocker() {
            if (document.getElementById('ads-loading-blocker')) return;

            try {
                prevHtmlOverflow = document.documentElement.style.overflow || '';
                prevBodyOverflow = document.body.style.overflow || '';
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';
            } catch (_) { }

            attachCaptureBlockers();

            const el = document.createElement('div');
            el.id = 'ads-loading-blocker';

            Object.assign(el.style, {
                position: 'fixed',
                inset: '0',
                width: '100%',
                height: '100%',
                zIndex: '2147483647',
                background: 'rgba(0,0,0,0.35)',
                backdropFilter: 'blur(2px)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                pointerEvents: 'auto',
                touchAction: 'none'
            });

            // ---- Loader UI ----
            el.innerHTML = `
      <div style="
        color:#e5e7eb;
        padding:14px 18px;
        border-radius:14px;
        box-shadow:0 10px 35px rgba(0,0,0,.35);
        font-family: system-ui, -apple-system, Segoe UI, Roboto;
        text-align:center;
        min-width:120px;
      ">
        <div style="
          width:26px;height:26px;
          border-radius:50%;
          border:3px solid #38bdf8;
          border-top-color:transparent;
          margin:0 auto 8px auto;
          animation: adsSpin 0.85s linear infinite;
        "></div>
        <div style="font-size:12px;opacity:.9;">
          Loadingâ€¦
        </div>
      </div>
    `;

            // animation keyframes
            const style = document.createElement('style');
            style.textContent = `
      @keyframes adsSpin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    `;
            document.head.appendChild(style);

            document.body.appendChild(el);
        }

        function removeLoadingBlocker() {
            try {
                const el = document.getElementById('ads-loading-blocker');
                if (el) el.remove();
            } catch (_) { }

            try {
                document.documentElement.style.overflow = prevHtmlOverflow;
                document.body.style.overflow = prevBodyOverflow;
            } catch (_) { }

            removeCaptureBlockers();
        }

        function clearAllTimers() {
            if (overallTimer) clearTimeout(overallTimer);
            if (pollInterval) clearInterval(pollInterval);
            overallTimer = null;
            pollInterval = null;
        }

        function tryShowWithTimeout(showFn) {
            return new Promise((resolve, reject) => {
                let settled = false;

                const safety = setTimeout(() => {
                    if (settled) return;
                    settled = true;
                    reject(new Error('ad-timeout'));
                }, AD_SHOW_TIMEOUT_MS);

                Promise.resolve()
                    .then(() => showFn())
                    .then(res => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        resolve(res);
                    })
                    .catch(err => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        reject(err);
                    });
            });
        }

        function runShowFlow() {
            try {
                createLoadingBlocker();

                // overall watchdog
                overallTimer = setTimeout(() => {
                    clearAllTimers();
                    removeLoadingBlocker();
                }, AD_SHOW_TIMEOUT_MS);

                // keep polling until function appears OR timeout hits
                pollInterval = setInterval(() => {
                    const fn = window[SHOW_FN_NAME];
                    if (typeof fn === 'function') {
                        clearAllTimers();

                        tryShowWithTimeout(fn)
                            .then(() => removeLoadingBlocker())
                            .catch(() => removeLoadingBlocker());
                    }
                }, SDK_POLL_INTERVAL_MS);

            } catch (_) {
                clearAllTimers();
                removeLoadingBlocker();
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runShowFlow);
        } else {
            runShowFlow();
        }

    })();
</script>