<!-- Main Wrapper -->
<section class="w-full max-w-sm bg-white rounded-xl shadow-2xl overflow-hidden flex flex-col min-h-[100svh]">
    <!-- Main Content: Grid -->
    <main id="contentGrid"
        class="flex-1 overflow-y-scroll px-6 py-6 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 bg-gray-50 animate-background">

        <% const shimmerCount=movies && movies.length> 0 ? movies.length : 8; %>
            <% for (let i=0; i < shimmerCount; i++) { %>
                <div class="bg-white shadow-md rounded-lg overflow-hidden animate-pulse p-1">
                    <!-- Image placeholder -->
                    <div class="w-[143px] h-[281px] bg-gray-300 rounded-lg mb-3"></div>
                    <!-- Title placeholder -->
                    <div class="h-4 bg-gray-300 rounded w-3/4 mx-auto mb-2"></div>
                    <!-- Language/genre placeholder -->
                    <div class="h-3 bg-gray-300 rounded w-1/2 mx-auto mb-2"></div>
                    <!-- Category placeholder -->
                    <div class="h-3 bg-gray-300 rounded w-1/3 mx-auto"></div>
                </div>
                <% } %>
    </main>

    <!-- Pagination -->
    <footer id="pagination" class="px-6 mt-3 pb-3 flex justify-center space-x-2"></footer>

    <!-- Navigation / Footer -->
    <%- include('../partials/footer') %>
</section>

<script>
    const contentGrid = document.getElementById('contentGrid');
    const footer = document.getElementById('pagination');

    let type = 'movie';      // FIXED
    let category = '';       // FIXED (All means blank)
    let currentPage = 1;
    let searchQuery = "<%= movie_query %>";  // ðŸ‘ˆ controller se aa raha hai

    // Page load pe default content fetch karo
    document.addEventListener("DOMContentLoaded", () => {
        fetchContent(currentPage);
    });

    // Fetch data
    async function fetchContent(page = 1) {
        currentPage = page;

        try {
            // EJS injected base token/domain
            const url = `/<%= token %>/movies-hub/search?type=${type}&search=${encodeURIComponent(searchQuery)}&category=${encodeURIComponent(category)}&page=${page}`;
            const res = await axios.get(url);

            const { success, movies, totalPages } = res.data;

            if (!success || !movies || movies.length === 0) {
                contentGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full">No movies found.</p>`;
                footer.innerHTML = "";
                return;
            }

            // Render movies
            contentGrid.innerHTML = movies.map(movie => `
                <a href="/<%= token %>/movies-hub/movie_details?userId=<%= user_id %>&movie_id=${movie._id}&fromId=<%= fromId %>"
                    class="content-item bg-white shadow-md rounded-lg overflow-hidden hover:shadow-xl transition p-1"
                    data-type="movie">
                    <div class="w-full h-[200px] bg-gray-200 overflow-hidden rounded-lg">
                        <img src="${movie.thumbnail}" alt="${movie.title}" class="w-full h-full object-fill">
                    </div>
                    <div class="p-3 text-center">
                        <h2 class="text-sm font-bold text-gray-800 truncate-3-lines">${movie.title}</h2>
                        <div class="flex flex-wrap justify-center gap-2 mt-2">
                            ${movie.language.split(",").map(lang => `
                                <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-600 rounded-full">${lang.trim()}</span>
                            `).join("")}
                        </div>
                        <p class="text-xs text-gray-600 mt-2">${movie.genre}</p>
                        <p class="text-xs text-purple-500 mt-1 font-semibold">${movie.category}</p>
                    </div>
                </a>
            `).join("");


            renderPagination(totalPages);

        } catch (err) {
            console.error("Error fetching movies:", err);
            contentGrid.innerHTML = `<p class="text-center text-red-500 col-span-full">Error loading movies.</p>`;
            footer.innerHTML = "";
        }
    }

    // Pagination rendering
    function renderPagination(totalPages) {
        footer.innerHTML = "";

        if (!totalPages || totalPages <= 1) return;

        // Prev
        if (currentPage > 1) {
            footer.innerHTML += `<a href="#" data-page="${currentPage - 1}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Prev</a>`;
        }

        let tokens = [];

        if (totalPages <= 5) {
            for (let i = 1; i <= totalPages; i++) tokens.push(i);
        } else {
            if (currentPage <= 3) {
                tokens = [1, 2, 3, '...', totalPages];
            } else if (currentPage >= totalPages - 2) {
                tokens = [1, '...', totalPages - 2, totalPages - 1, totalPages];
            } else {
                tokens = [1, '...', currentPage, '...', totalPages];
            }
        }

        // Render tokens
        tokens.forEach(token => {
            if (token === '...') {
                footer.innerHTML += `<span class="px-3 py-1 text-gray-500">...</span>`;
            } else {
                const isActive = token === currentPage;
                footer.innerHTML += `<a href="#" data-page="${token}" class="px-3 py-1 rounded ${isActive ? 'bg-blue-500 text-white' : 'bg-gray-200 hover:bg-gray-300'}">${token}</a>`;
            }
        });

        // Next
        if (currentPage < totalPages) {
            footer.innerHTML += `<a href="#" data-page="${currentPage + 1}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>`;
        }

        // Attach click handlers
        footer.querySelectorAll('a[data-page]').forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const page = parseInt(link.dataset.page);
                if (!isNaN(page)) fetchContent(page);
            });
        });
    }
</script>
<!-- Ads on first page load (client-only) -->
<script>
    (function () {
        const ADS_BLOCK_ID = 'int-20013'; // <-- replace with your AdsGram block id
        const SESSION_KEY = 'ads_shown_find_movies_v1';
        const SAFETY_TIMEOUT_MS = 8000;
        let AdController = null;
        let sdkLoaded = false;
        let sdkRequested = false;

        function loadAdsgramSDK() {
            return new Promise((resolve) => {
                if (sdkRequested) {
                    // wait until sdkLoaded becomes true or small timeout
                    const start = Date.now();
                    const check = setInterval(() => {
                        if (sdkLoaded || (Date.now() - start) > 1200) { clearInterval(check); resolve(sdkLoaded); }
                    }, 100);
                    return;
                }
                sdkRequested = true;

                if (window.Adsgram && typeof window.Adsgram.init === 'function') {
                    try {
                        AdController = window.Adsgram.init({ blockId: ADS_BLOCK_ID });
                        sdkLoaded = true;
                        resolve(true);
                        return;
                    } catch (e) {
                        console.error('Adsgram init error:', e);
                    }
                }

                const s = document.createElement('script');
                s.src = 'https://sad.adsgram.ai/js/sad.min.js';
                s.async = true;
                s.onload = function () {
                    try {
                        if (window.Adsgram && typeof window.Adsgram.init === 'function') {
                            AdController = window.Adsgram.init({ blockId: ADS_BLOCK_ID });
                            sdkLoaded = true;
                            resolve(true);
                            return;
                        }
                    } catch (err) {
                        console.error('Adsgram init after load failed:', err);
                    }
                    resolve(false);
                };
                s.onerror = function () {
                    console.error('Failed to load Adsgram SDK.');
                    resolve(false);
                };
                document.head.appendChild(s);

                // fallback resolve after short delay in case onload doesn't fire quickly
                setTimeout(() => { if (!sdkLoaded) resolve(sdkLoaded); }, 1200);
            });
        }

        async function showAdIfNeeded() {
            try {
                // Only show once per session/tab
                if (sessionStorage.getItem(SESSION_KEY)) return;

                // try to load SDK (non-blocking)
                const ready = await loadAdsgramSDK();

                // if no SDK, do nothing
                if (!ready || !AdController || typeof AdController.show !== 'function') return;

                // show ad with safety timeout
                const t = setTimeout(() => {
                    // if ad didn't start / resolve within timeout, just mark shown so we don't retry
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                }, SAFETY_TIMEOUT_MS);

                try {
                    const res = await AdController.show();
                    clearTimeout(t);
                    // mark as shown regardless of completion/skipped to avoid repeat
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                } catch (err) {
                    clearTimeout(t);
                    console.error('Adsgram show error:', err);
                    try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
                }
            } catch (e) {
                console.error('Error while attempting to show ad on page load', e);
                try { sessionStorage.setItem(SESSION_KEY, '1'); } catch (e) { }
            }
        }

        // Run on DOMContentLoaded - ensure page UI is ready first
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showAdIfNeeded);
        } else {
            showAdIfNeeded();
        }
    })();
</script>