<!-- Pending Section -->
<div id="pending-section">
    <h2 class="text-xl font-bold mb-3 text-yellow-700">⏳ Pending Requests</h2>
    <div id="pending-requests" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        <% pending_requests.forEach(req=> { %>
            <div id="req-<%= req._id %>" class="p-4 bg-white rounded-xl shadow-md flex flex-col gap-2">
                <h3 class="text-lg font-bold">
                    <%= req.title %> (<%= req.type %>)
                </h3>
                <p class="text-sm text-gray-600">Lang: <%= req.language %>
                </p>
                <p class="text-sm text-gray-600">Requested by: <%= req.requested_by %>
                </p>
                <span class="px-2 py-1 text-xs rounded-md bg-yellow-200 text-yellow-800">⏳ Pending</span>
                <form onsubmit="return updateRequest(event, '<%= req._id %>')" class="flex flex-col gap-2 mt-2">
                    <select name="status" class="border rounded p-1">
                        <option value="true">Completed</option>
                        <option value="false" selected>Pending</option>
                    </select>
                    <textarea name="message" placeholder="Send message (optional)"
                        class="border rounded p-2 text-sm"></textarea>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-md py-1 px-3">Update</button>
                </form>
            </div>
            <% }) %>
    </div>
</div>

<script>
    const token = "<%= token %>";
    async function updateRequest(e, requestId) {
        e.preventDefault();
        const form = e.target;
        const status = form.status.value;
        const message = form.message.value;

        try {
            const res = await axios.post(`/${token}/movies-hub/update_request`, {
                requestId,
                status,
                message
            });

            if (res.data.success) {
                // Pending se remove karo
                document.getElementById("req-" + requestId)?.remove();

                alert("✅ Request updated successfully!");
            } else {
                alert("❌ Failed: " + res.data.message);
            }
        } catch (err) {
            console.error("Error updating request:", err);
            alert("⚠️ Something went wrong!");
        }
    }
</script>

<!-- Monetag: auto-show rewarded interstitial (silent failures) -->
<script>
    (function () {
        // CONFIG
        const SHOW_FN_NAME = 'show_10399268'; // agar tumhara function alag name ho to yahan change kar do
        const AD_SHOW_TIMEOUT_MS = 8000;      // ad show promise ke liye safety timeout
        const SDK_POLL_INTERVAL_MS = 500;     // agar SDK thoda late load ho to poll karega
        const SDK_POLL_MAX_ATTEMPTS = 8;      // maximum attempts to find the function

        function tryShowWithTimeout(showFn) {
            return new Promise((resolve, reject) => {
                let settled = false;
                const safety = setTimeout(() => {
                    if (settled) return;
                    settled = true;
                    // swallow timeout as failure
                    reject(new Error('ad-timeout'));
                }, AD_SHOW_TIMEOUT_MS);

                // call the show function (it returns a promise in Monetag example)
                Promise.resolve()
                    .then(() => showFn())
                    .then((res) => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        resolve(res);
                    })
                    .catch((err) => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        reject(err);
                    });
            });
        }

        function silentNoop() {
            // intentionally empty: no UI, no alert, no console error output to user
        }

        function runShowFlow() {
            try {
                const globalFn = window[SHOW_FN_NAME];
                if (typeof globalFn === 'function') {
                    // try show, but swallow any error or timeout silently
                    tryShowWithTimeout(globalFn).then(() => {
                        // success -> perform any silent post-ad action here if needed
                        // e.g. call a reward function (but don't alert)
                        // rewardUser(); // optional
                    }).catch(() => {
                        // swallow
                    });
                    return;
                }

                // If function not yet present, poll a few times (SDK might be loaded async)
                let attempts = 0;
                const iv = setInterval(() => {
                    attempts++;
                    const fnNow = window[SHOW_FN_NAME];
                    if (typeof fnNow === 'function') {
                        clearInterval(iv);
                        tryShowWithTimeout(fnNow).catch(() => { /* swallow */ });
                        return;
                    }
                    if (attempts >= SDK_POLL_MAX_ATTEMPTS) {
                        clearInterval(iv);
                        // give up silently
                    }
                }, SDK_POLL_INTERVAL_MS);
            } catch (e) {
                // final guard: swallow everything
                try { silentNoop(); } catch (e2) { }
            }
        }

        // Run on DOM ready (non-blocking)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runShowFlow);
        } else {
            runShowFlow();
        }
    })();
</script>