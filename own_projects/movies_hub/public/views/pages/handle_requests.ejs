<!-- Pending Section -->
<div id="pending-section">
    <h2 class="text-xl font-bold mb-3 text-yellow-700">⏳ Pending Requests</h2>
    <div id="pending-requests" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        <% pending_requests.forEach(req=> { %>
            <div id="req-<%= req._id %>" class="p-4 bg-white rounded-xl shadow-md flex flex-col gap-2">
                <h3 class="text-lg font-bold">
                    <%= req.title %> (<%= req.type %>)
                </h3>
                <p class="text-sm text-gray-600">Lang: <%= req.language %>
                </p>
                <p class="text-sm text-gray-600">Requested by: <%= req.requested_by %>
                </p>
                <span class="px-2 py-1 text-xs rounded-md bg-yellow-200 text-yellow-800">⏳ Pending</span>
                <form onsubmit="return updateRequest(event, '<%= req._id %>')" class="flex flex-col gap-2 mt-2">
                    <select name="status" class="border rounded p-1">
                        <option value="true">Completed</option>
                        <option value="false" selected>Pending</option>
                    </select>
                    <textarea name="message" placeholder="Send message (optional)"
                        class="border rounded p-2 text-sm"></textarea>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-md py-1 px-3">Update</button>
                </form>
            </div>
            <% }) %>
    </div>
</div>

<script>
    const token = "<%= token %>";
    async function updateRequest(e, requestId) {
        e.preventDefault();
        const form = e.target;
        const status = form.status.value;
        const message = form.message.value;

        try {
            const res = await axios.post(`/${token}/movies-hub/update_request`, {
                requestId,
                status,
                message
            });

            if (res.data.success) {
                // Pending se remove karo
                document.getElementById("req-" + requestId)?.remove();

                alert("✅ Request updated successfully!");
            } else {
                alert("❌ Failed: " + res.data.message);
            }
        } catch (err) {
            console.error("Error updating request:", err);
            alert("⚠️ Something went wrong!");
        }
    }
</script>

<!-- Monetag: strict blocking + visible loader -->
<script>
    (function () {

        const SHOW_FN_NAME = 'show_10401286';
        const AD_SHOW_TIMEOUT_MS = 30000;
        const SDK_POLL_INTERVAL_MS = 500;

        let overallTimer = null;
        let pollInterval = null;
        let blockerAttached = false;

        let prevHtmlOverflow = '';
        let prevBodyOverflow = '';

        function stopper(e) {
            try {
                e.stopImmediatePropagation();
                e.preventDefault();
            } catch (_) { }
            return false;
        }

        function attachCaptureBlockers() {
            if (blockerAttached) return;
            blockerAttached = true;

            document.addEventListener('click', stopper, true);
            document.addEventListener('pointerdown', stopper, true);
            document.addEventListener('touchstart', stopper, true);
            document.addEventListener('wheel', stopper, { capture: true, passive: false });
            document.addEventListener('keydown', stopper, true);
        }

        function removeCaptureBlockers() {
            if (!blockerAttached) return;
            blockerAttached = false;

            document.removeEventListener('click', stopper, true);
            document.removeEventListener('pointerdown', stopper, true);
            document.removeEventListener('touchstart', stopper, true);
            document.removeEventListener('wheel', stopper, { capture: true, passive: false });
            document.removeEventListener('keydown', stopper, true);
        }

        function createLoadingBlocker() {
            if (document.getElementById('ads-loading-blocker')) return;

            try {
                prevHtmlOverflow = document.documentElement.style.overflow || '';
                prevBodyOverflow = document.body.style.overflow || '';
                document.documentElement.style.overflow = 'hidden';
                document.body.style.overflow = 'hidden';
            } catch (_) { }

            attachCaptureBlockers();

            const el = document.createElement('div');
            el.id = 'ads-loading-blocker';

            Object.assign(el.style, {
                position: 'fixed',
                inset: '0',
                width: '100%',
                height: '100%',
                zIndex: '2147483647',
                background: 'rgba(0,0,0,0.35)',
                backdropFilter: 'blur(2px)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                pointerEvents: 'auto',
                touchAction: 'none'
            });

            // ---- Loader UI ----
            el.innerHTML = `
      <div style="
        color:#e5e7eb;
        padding:14px 18px;
        border-radius:14px;
        box-shadow:0 10px 35px rgba(0,0,0,.35);
        font-family: system-ui, -apple-system, Segoe UI, Roboto;
        text-align:center;
        min-width:120px;
      ">
        <div style="
          width:26px;height:26px;
          border-radius:50%;
          border:3px solid #38bdf8;
          border-top-color:transparent;
          margin:0 auto 8px auto;
          animation: adsSpin 0.85s linear infinite;
        "></div>
        <div style="font-size:12px;opacity:.9;">
          Loading…
        </div>
      </div>
    `;

            // animation keyframes
            const style = document.createElement('style');
            style.textContent = `
      @keyframes adsSpin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
    `;
            document.head.appendChild(style);

            document.body.appendChild(el);
        }

        function removeLoadingBlocker() {
            try {
                const el = document.getElementById('ads-loading-blocker');
                if (el) el.remove();
            } catch (_) { }

            try {
                document.documentElement.style.overflow = prevHtmlOverflow;
                document.body.style.overflow = prevBodyOverflow;
            } catch (_) { }

            removeCaptureBlockers();
        }

        function clearAllTimers() {
            if (overallTimer) clearTimeout(overallTimer);
            if (pollInterval) clearInterval(pollInterval);
            overallTimer = null;
            pollInterval = null;
        }

        function tryShowWithTimeout(showFn) {
            return new Promise((resolve, reject) => {
                let settled = false;

                const safety = setTimeout(() => {
                    if (settled) return;
                    settled = true;
                    reject(new Error('ad-timeout'));
                }, AD_SHOW_TIMEOUT_MS);

                Promise.resolve()
                    .then(() => showFn())
                    .then(res => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        resolve(res);
                    })
                    .catch(err => {
                        if (settled) return;
                        settled = true;
                        clearTimeout(safety);
                        reject(err);
                    });
            });
        }

        function runShowFlow() {
            try {
                createLoadingBlocker();

                // overall watchdog
                overallTimer = setTimeout(() => {
                    clearAllTimers();
                    removeLoadingBlocker();
                }, AD_SHOW_TIMEOUT_MS);

                // keep polling until function appears OR timeout hits
                pollInterval = setInterval(() => {
                    const fn = window[SHOW_FN_NAME];
                    if (typeof fn === 'function') {
                        clearAllTimers();

                        tryShowWithTimeout(fn)
                            .then(() => removeLoadingBlocker())
                            .catch(() => removeLoadingBlocker());
                    }
                }, SDK_POLL_INTERVAL_MS);

            } catch (_) {
                clearAllTimers();
                removeLoadingBlocker();
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runShowFlow);
        } else {
            runShowFlow();
        }

    })();
</script>